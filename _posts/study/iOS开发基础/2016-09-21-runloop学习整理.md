---
layout: post
category: iOSå¼€å‘åŸºç¡€
title : "RunLoopå­¦ä¹ æ•´ç†"
---



### ä¸€ã€ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ

```
ä¸€èˆ¬æ¥è®²ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåçº¿ç¨‹å°±ä¼šé€€å‡ºã€‚å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœºåˆ¶ï¼Œè®©çº¿ç¨‹èƒ½éšæ—¶å¤„ç†äº‹ä»¶ä½†å¹¶ä¸é€€å‡ºï¼Œé€šå¸¸çš„ä»£ç é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š

function loop() {
    initialize();
    do {
        var message = get_next_message();
        process_message(message);
    } while (message != quit);
}

è¿™ç§æ¨¡å‹é€šå¸¸è¢«ç§°ä½œ Event Loopã€‚ Event Loop åœ¨å¾ˆå¤šç³»ç»Ÿå’Œæ¡†æ¶é‡Œéƒ½æœ‰å®ç°ï¼Œæ¯”å¦‚ Node.js çš„äº‹ä»¶å¤„ç†ï¼Œæ¯”å¦‚ Windows ç¨‹åºçš„æ¶ˆæ¯å¾ªç¯ï¼Œå†æ¯”å¦‚ OSX/iOS é‡Œçš„ RunLoopã€‚å®ç°è¿™ç§æ¨¡å‹çš„å…³é”®ç‚¹åœ¨äºï¼šå¦‚ä½•ç®¡ç†äº‹ä»¶/æ¶ˆæ¯ï¼Œå¦‚ä½•è®©çº¿ç¨‹åœ¨æ²¡æœ‰å¤„ç†æ¶ˆæ¯æ—¶ä¼‘çœ ä»¥é¿å…èµ„æºå ç”¨ã€åœ¨æœ‰æ¶ˆæ¯åˆ°æ¥æ—¶ç«‹åˆ»è¢«å”¤é†’ã€‚

æ‰€ä»¥ï¼ŒRunLoop å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç®¡ç†äº†å…¶éœ€è¦å¤„ç†çš„äº‹ä»¶å’Œæ¶ˆæ¯ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªå…¥å£å‡½æ•°æ¥æ‰§è¡Œä¸Šé¢ Event Loop çš„é€»è¾‘ã€‚çº¿ç¨‹æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°åï¼Œå°±ä¼šä¸€ç›´å¤„äºè¿™ä¸ªå‡½æ•°å†…éƒ¨ â€œæ¥å—æ¶ˆæ¯->ç­‰å¾…->å¤„ç†â€ çš„å¾ªç¯ä¸­ï¼Œç›´åˆ°è¿™ä¸ªå¾ªç¯ç»“æŸï¼ˆæ¯”å¦‚ä¼ å…¥ quit çš„æ¶ˆæ¯ï¼‰ï¼Œå‡½æ•°è¿”å›ã€‚

iOS ç³»ç»Ÿä¸­ï¼Œæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼šNSRunLoop å’Œ CFRunLoopRefã€‚
CFRunLoopRef æ˜¯åœ¨ CoreFoundation æ¡†æ¶å†…çš„ï¼Œå®ƒæä¾›äº†çº¯ C å‡½æ•°çš„ APIï¼Œæ‰€æœ‰è¿™äº› API éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
NSRunLoop æ˜¯åŸºäº CFRunLoopRef çš„å°è£…ï¼Œæä¾›äº†é¢å‘å¯¹è±¡çš„ APIï¼Œä½†æ˜¯è¿™äº› API ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
```



å…¶å®ï¼Œå·¥ä½œä¸­çš„å¤§éƒ¨åˆ†æ—¶é—´ï¼Œæˆ‘ä»¬æ˜¯ä¸æ€ä¹ˆä½¿ç”¨runloopçš„ï¼Œäº†è§£runloopæ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Œå¯¹é—®é¢˜å‘ç”Ÿåçš„å¤„ç†ã€å’Œå¯¹iOSç³»ç»Ÿçš„å·¥ä½œä¼šæœ‰ä¸€ä¸ªæ›´æ·±çš„è®¤çŸ¥ã€‚

è¿™é‡Œæ•´ç†ä¸€ä¸‹ä»€ä¹ˆæ˜¯runloopï¼Œåº”è¯¥æ³¨æ„äº›ä»€ä¹ˆï¼Œæ—¥å¸¸å“ªé‡Œçš„ä½¿ç”¨æ›´å¤šï¼ŒiOSæœ¬èº«ç”¨ä»–åšäº†äº›ä»€ä¹ˆã€‚

ä¸ºäº†ç†è§£runloopçš„æ„ä¹‰ï¼Œåˆ—ä¸¾å‡ ä¸ªæœ€æ¥è¿‘æ—¥å¸¸å¼€å‘çš„ä½¿ç”¨ç‚¹ï¼š

```
1ã€æœ€ç†Ÿæ‚‰çš„å®šæ—¶å™¨ä»»åŠ¡

2ã€åŸºæœ¬éƒ½é‡è§çš„bugï¼ŒscrollViewæ»‘åŠ¨çš„æ—¶å€™è®¡æ—¶å™¨ä¸èµ°äº†

3ã€è‡ªåŠ¨é‡Šæ”¾æ± çš„å·¥ä½œ

4ã€performSelecterçš„ä½¿ç”¨
```

RunLoopçš„æ¦‚å¿µå‰é¢ç®€å•ä»‹ç»äº†ï¼Œå¹³æ—¶æˆ‘ä»¬æ¶‰åŠåˆ°RunLoopï¼Œé‚£ä¹ˆå°±ä¼šæ¶‰åŠåˆ°çº¿ç¨‹ï¼Œä»–ä»¬ä¹‹é—´åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»?

### äºŒã€RunLoopä¸çº¿ç¨‹çš„å…³ç³»

è‹¹æœä¸å…è®¸ç›´æ¥åˆ›å»º RunLoopï¼Œå®ƒåªæä¾›äº†ä¸¤ä¸ªè‡ªåŠ¨è·å–çš„å‡½æ•°ï¼šCFRunLoopGetMain() å’Œ CFRunLoopGetCurrent()ã€‚ è¿™ä¸¤ä¸ªå‡½æ•°å†…éƒ¨çš„é€»è¾‘å¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·:

```
/// å…¨å±€çš„Dictionaryï¼Œkey æ˜¯ pthread_tï¼Œ value æ˜¯ CFRunLoopRef
static CFMutableDictionaryRef loopsDic;
/// è®¿é—® loopsDic æ—¶çš„é”
static CFSpinLock_t loopsLock;
 
/// è·å–ä¸€ä¸ª pthread å¯¹åº”çš„ RunLoopã€‚
CFRunLoopRef _CFRunLoopGet(pthread_t thread) {
    OSSpinLockLock(&loopsLock);
    
    if (!loopsDic) {
        // ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶ï¼Œåˆå§‹åŒ–å…¨å±€Dicï¼Œå¹¶å…ˆä¸ºä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ª RunLoopã€‚
        loopsDic = CFDictionaryCreateMutable();
        CFRunLoopRef mainLoop = _CFRunLoopCreate();
        CFDictionarySetValue(loopsDic, pthread_main_thread_np(), mainLoop);
    }
    
    /// ç›´æ¥ä» Dictionary é‡Œè·å–ã€‚
    CFRunLoopRef loop = CFDictionaryGetValue(loopsDic, thread));
    
    if (!loop) {
        /// å–ä¸åˆ°æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª
        loop = _CFRunLoopCreate();
        CFDictionarySetValue(loopsDic, thread, loop);
        /// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“çº¿ç¨‹é”€æ¯æ—¶ï¼Œé¡ºä¾¿ä¹Ÿé”€æ¯å…¶å¯¹åº”çš„ RunLoopã€‚
        _CFSetTSD(..., thread, loop, __CFFinalizeRunLoop);
    }
    
    OSSpinLockUnLock(&loopsLock);
    return loop;
}
 
CFRunLoopRef CFRunLoopGetMain() {
    return _CFRunLoopGet(pthread_main_thread_np());
}
 
CFRunLoopRef CFRunLoopGetCurrent() {
    return _CFRunLoopGet(pthread_self());
}
```

æ‰€ä»¥ï¼Œçº¿ç¨‹å’Œ RunLoop ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„ Dictionary é‡Œã€‚çº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰ RunLoopï¼Œå¦‚æœä½ ä¸ä¸»åŠ¨è·å–ï¼Œé‚£å®ƒä¸€ç›´éƒ½ä¸ä¼šæœ‰ã€‚RunLoop çš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼ŒRunLoop çš„é”€æ¯æ˜¯å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶ã€‚ä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶ RunLoopï¼ˆä¸»çº¿ç¨‹é™¤å¤–ï¼‰ã€‚

### ä¸‰ã€è¯¦ç»†äº†è§£RunLoop 



runloopå¯¹å¤–çš„æ¥å£

åœ¨ CoreFoundation é‡Œé¢å…³äº RunLoop æœ‰5ä¸ªç±»:

```
CFRunLoopRef
CFRunLoopModeRef
CFRunLoopSourceRef
CFRunLoopTimerRef
CFRunLoopObserverRef
```

å…¶ä¸­ CFRunLoopModeRef ç±»å¹¶æ²¡æœ‰å¯¹å¤–æš´éœ²ï¼Œåªæ˜¯é€šè¿‡ CFRunLoopRef çš„æ¥å£è¿›è¡Œäº†å°è£…ã€‚ä»–ä»¬çš„å…³ç³»å¦‚ä¸‹:

![](https://xilankong.github.io/resource/runLoopOne.png)



ä¸€ä¸ª RunLoop åŒ…å«è‹¥å¹²ä¸ª Modeï¼Œæ¯ä¸ª Mode åˆåŒ…å«è‹¥å¹²ä¸ª Source/Timer/Observerã€‚æ¯æ¬¡è°ƒç”¨ RunLoop çš„ä¸»å‡½æ•°æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ª Modeï¼Œè¿™ä¸ªModeè¢«ç§°ä½œ CurrentModeã€‚å¦‚æœéœ€è¦åˆ‡æ¢ Modeï¼Œåªèƒ½é€€å‡º Loopï¼Œå†é‡æ–°æŒ‡å®šä¸€ä¸ª Mode è¿›å…¥ã€‚è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„ Source/Timer/Observerï¼Œè®©å…¶äº’ä¸å½±å“ã€‚

#### CFRunLoopSourceRefæ˜¯äº‹ä»¶äº§ç”Ÿçš„åœ°æ–¹

source_0 å’Œ source_1 åˆ†åˆ«æ˜¯ä»€ä¹ˆ

ä»»åŠ¡æ¿€æ´»æº

source_0ï¼šéportï¼Œ è§¦æ‘¸äº‹ä»¶ï¼ŒPerformSelectors



source_1ï¼šåŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡





#### CFRunLoopTimerRef æ˜¯åŸºäºæ—¶é—´çš„è§¦å‘å™¨

å®ƒå’Œ NSTimer æ˜¯toll-free bridged çš„ï¼Œå¯ä»¥æ··ç”¨ã€‚å…¶åŒ…å«ä¸€ä¸ªæ—¶é—´é•¿åº¦å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ã€‚å½“å…¶åŠ å…¥åˆ° RunLoop æ—¶ï¼ŒRunLoopä¼šæ³¨å†Œå¯¹åº”çš„æ—¶é—´ç‚¹ï¼Œå½“æ—¶é—´ç‚¹åˆ°æ—¶ï¼ŒRunLoopä¼šè¢«å”¤é†’ä»¥æ‰§è¡Œé‚£ä¸ªå›è°ƒã€‚

#### CFRunLoopObserverRef æ˜¯è§‚å¯Ÿè€…

æ¯ä¸ª Observer éƒ½åŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå½“ RunLoop çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§‚å¯Ÿè€…å°±èƒ½é€šè¿‡å›è°ƒæ¥å—åˆ°è¿™ä¸ªå˜åŒ–ã€‚å¯ä»¥è§‚æµ‹çš„æ—¶é—´ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

```
typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
    kCFRunLoopEntry         = (1UL << 0), // å³å°†è¿›å…¥Loop
    kCFRunLoopBeforeTimers  = (1UL << 1), // å³å°†å¤„ç† Timer
    kCFRunLoopBeforeSources = (1UL << 2), // å³å°†å¤„ç† Source
    kCFRunLoopBeforeWaiting = (1UL << 5), // å³å°†è¿›å…¥ä¼‘çœ 
    kCFRunLoopAfterWaiting  = (1UL << 6), // åˆšä»ä¼‘çœ ä¸­å”¤é†’
    kCFRunLoopExit          = (1UL << 7), // å³å°†é€€å‡ºLoop
};
```

ä¸Šé¢çš„ Source/Timer/Observer è¢«ç»Ÿç§°ä¸º mode itemã€‚

1ã€ä¸€ä¸ª item å¯ä»¥è¢«åŒæ—¶åŠ å…¥å¤šä¸ª modeï¼Œä½†ä¸€ä¸ª item è¢«é‡å¤åŠ å…¥åŒä¸€ä¸ª mode æ—¶æ˜¯ä¸ä¼šæœ‰æ•ˆæœçš„ã€‚

2ã€å¦‚æœä¸€ä¸ª mode ä¸­ä¸€ä¸ª item éƒ½æ²¡æœ‰ï¼Œåˆ™ RunLoop ä¼šç›´æ¥é€€å‡ºï¼Œä¸è¿›å…¥å¾ªç¯ã€‚

3ã€å¦‚æœmodeä¸­åªæœ‰è§‚å¯Ÿè€… ä¹Ÿä¸ä¼šè¿›å…¥å¾ªç¯ã€‚



### RunLoopçš„Mode

CFRunLoopMode å’Œ CFRunLoop çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š

```
struct __CFRunLoopMode {
    CFStringRef _name;            // Mode Name, ä¾‹å¦‚ @"kCFRunLoopDefaultMode"
    CFMutableSetRef _sources0;    // Set
    CFMutableSetRef _sources1;    // Set
    CFMutableArrayRef _observers; // Array
    CFMutableArrayRef _timers;    // Array
    ...
};
 
struct __CFRunLoop {
    CFMutableSetRef _commonModes;     // Set
    CFMutableSetRef _commonModeItems; // Set<Source/Observer/Timer>
    CFRunLoopModeRef _currentMode;    // Current Runloop Mode
    CFMutableSetRef _modes;           // Set
    ...
};
```

è¿™é‡Œæœ‰ä¸ªæ¦‚å¿µå« â€œCommonModesâ€ï¼šä¸€ä¸ª Mode å¯ä»¥å°†è‡ªå·±æ ‡è®°ä¸ºâ€Commonâ€å±æ€§ï¼ˆé€šè¿‡å°†å…¶ ModeName æ·»åŠ åˆ° RunLoop çš„ â€œcommonModesâ€ ä¸­ï¼‰ã€‚æ¯å½“ RunLoop çš„å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒRunLoop éƒ½ä¼šè‡ªåŠ¨å°† _commonModeItems é‡Œçš„ Source/Observer/Timer åŒæ­¥åˆ°å…·æœ‰ â€œCommonâ€ æ ‡è®°çš„æ‰€æœ‰Modeé‡Œã€‚

**åº”ç”¨åœºæ™¯ä¸¾ä¾‹ï¼š**

ä¸»çº¿ç¨‹çš„ RunLoop é‡Œæœ‰ä¸¤ä¸ªé¢„ç½®çš„ Modeï¼škCFRunLoopDefaultMode å’Œ UITrackingRunLoopModeã€‚è¿™ä¸¤ä¸ª Mode éƒ½å·²ç»è¢«æ ‡è®°ä¸ºâ€Commonâ€å±æ€§ã€‚DefaultMode æ˜¯ App å¹³æ—¶æ‰€å¤„çš„çŠ¶æ€ï¼ŒTrackingRunLoopMode æ˜¯è¿½è¸ª ScrollView æ»‘åŠ¨æ—¶çš„çŠ¶æ€ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ª Timer å¹¶åŠ åˆ° DefaultMode æ—¶ï¼ŒTimer ä¼šå¾—åˆ°é‡å¤å›è°ƒï¼Œä½†æ­¤æ—¶æ»‘åŠ¨ä¸€ä¸ªTableViewæ—¶ï¼ŒRunLoop ä¼šå°† mode åˆ‡æ¢ä¸º TrackingRunLoopModeï¼Œè¿™æ—¶ Timer å°±ä¸ä¼šè¢«å›è°ƒï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šå½±å“åˆ°æ»‘åŠ¨æ“ä½œã€‚

æœ‰æ—¶ä½ éœ€è¦ä¸€ä¸ª Timerï¼Œåœ¨ä¸¤ä¸ª Mode ä¸­éƒ½èƒ½å¾—åˆ°å›è°ƒ

```

ä¸€ç§åŠæ³•å°±æ˜¯å°†è¿™ä¸ª Timer åˆ†åˆ«åŠ å…¥è¿™ä¸¤ä¸ª Modeã€‚

è¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œå°±æ˜¯å°† Timer åŠ å…¥åˆ°é¡¶å±‚çš„ RunLoop çš„ â€œcommonModeItemsâ€ ä¸­ã€‚â€commonModeItemsâ€ è¢« RunLoop è‡ªåŠ¨æ›´æ–°åˆ°æ‰€æœ‰å…·æœ‰â€Commonâ€å±æ€§çš„ Mode é‡Œå»ã€‚

```



ä½ åªèƒ½é€šè¿‡ mode name æ¥æ“ä½œå†…éƒ¨çš„ modeï¼Œå½“ä½ ä¼ å…¥ä¸€ä¸ªæ–°çš„ mode name ä½† RunLoop å†…éƒ¨æ²¡æœ‰å¯¹åº” mode æ—¶ï¼ŒRunLoopä¼šè‡ªåŠ¨å¸®ä½ åˆ›å»ºå¯¹åº”çš„ CFRunLoopModeRefã€‚å¯¹äºä¸€ä¸ª RunLoop æ¥è¯´ï¼Œå…¶å†…éƒ¨çš„ mode åªèƒ½å¢åŠ ä¸èƒ½åˆ é™¤ã€‚

è‹¹æœå…¬å¼€æä¾›çš„ Mode æœ‰ä¸¤ä¸ªï¼škCFRunLoopDefaultMode (NSDefaultRunLoopMode) å’Œ UITrackingRunLoopModeï¼Œä½ å¯ä»¥ç”¨è¿™ä¸¤ä¸ª Mode Name æ¥æ“ä½œå…¶å¯¹åº”çš„ Modeã€‚

åŒæ—¶è‹¹æœè¿˜æä¾›äº†ä¸€ä¸ªæ“ä½œ Common æ ‡è®°çš„å­—ç¬¦ä¸²ï¼škCFRunLoopCommonModes (NSRunLoopCommonModes)ï¼Œä½ å¯ä»¥ç”¨è¿™ä¸ªå­—ç¬¦ä¸²æ¥æ“ä½œ Common Itemsï¼Œæˆ–æ ‡è®°ä¸€ä¸ª Mode ä¸º â€œCommonâ€ã€‚ä½¿ç”¨æ—¶æ³¨æ„åŒºåˆ†è¿™ä¸ªå­—ç¬¦ä¸²å’Œå…¶ä»– mode nameã€‚



1ã€NSTimerçš„ä½¿ç”¨:

```
NSTimer *timer = [NSTimer timerWithTimeInterval:1 target:self selector:@selector(wantTodo) userInfo:nil repeats:YES];

//timerWithå¼€å¤´çš„æ–¹æ³•åˆ›å»ºçš„Timerå¦‚æœä¸åŠ ä¸‹é¢ä¸€å¥æ— æ³•è¿è¡Œã€‚
[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];
```

2ã€NSTimerå’ŒscrollViewçš„å†²çªé—®é¢˜

```
æŠŠtimeråŠ åˆ°NSRunLoopCommonModesï¼Œé‚£ä¹ˆä¸¤ä¸ªmodeéƒ½ä¼šè¢«åˆ†é…ï¼Œè¿™æ ·ä¸¤ç§modeä¸‹éƒ½å¯ä»¥æ‰§è¡Œäº†ã€‚
[[NSRunLoop currentRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];
```

3ã€NSTimerå’ŒViewControllerçš„å¾ªç¯å¼•ç”¨

4ã€äº‹ä»¶æºçš„modeéœ€è¦å’Œå½“å‰runloopçš„mode ä¸€è‡´æ‰ä¼šè¿›å…¥å¾ªç¯ã€‚ï¼ˆæ¯”å¦‚æ·»åŠ ä¸€ä¸ªäº‹ä»¶æºåˆ°UITrackingRunLoopModeï¼Œä½†æ˜¯runloopé»˜è®¤æ˜¯NSDefaultRunLoopModeï¼‰



### å¦‚ä½•ä¿æŒä¸€ä¸ªçº¿ç¨‹ä¸€ç›´è¿è¡Œ

```
æŠŠrunloopå¼€å¯ä¸ºå¸¸é©»

å®ç°æµ‹è¯•ï¼š

//å¤–éƒ¨å¼€å…³
BOOL shouldKeepRunning;
//æµ‹è¯•çº¿ç¨‹
NSThread *myThread;


shouldKeepRunning = YES;
myThread = [[NSThread alloc]initWithBlock:^{
     [self doSth];
}];
[myThread start];
    
//æµ‹è¯•çº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•
- (void)doSth {
    
    NSRunLoop *runloop = [NSRunLoop currentRunLoop]; 
    [runloop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
	//whileå¾ªç¯æ¥ä¿è¯ä¸æŒ‚æ‰ï¼Œrunloopæ‰§è¡Œåˆ°æ°¸è¿œ~
    while (shouldKeepRunning && [runloop runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]) {
        NSLog(@"111");
        NSLog(@"%@",[NSThread currentThread]);
    }
}

//ç­‰ä¼šåœ¨æµ‹è¯•çº¿ç¨‹è§¦å‘è¿™ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œè®©runloopå”¤é†’
- (void)doOther {
    NSLog(@"22");
}
//æŒ‰é’®äº‹ä»¶
- (IBAction)send:(id)sender { 
    [self performSelector:@selector(doOther) onThread:myThread withObject:nil waitUntilDone:nil];
}

å½“æ²¡æœ‰æ“ä½œæŒ‰é’®çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šæ‰“å°æµ‹è¯•æ–¹æ³•ä¸­çš„  111

å½“æŒ‰é’®ç‚¹å‡»çš„æ—¶å€™

2018-12-04 15:26:40.965699+0800 cyuyan[6501:46603228] 111
2018-12-04 15:26:40.966892+0800 cyuyan[6501:46603228] <NSThread: 0x600000942940>{number = 3, name = (null)}

2018-12-04 15:26:49.882592+0800 cyuyan[6501:46603228] 111
2018-12-04 15:26:49.882885+0800 cyuyan[6501:46603228] <NSThread: 0x600000942940>{number = 3, name = (null)}

å¤šæ¬¡æµ‹è¯•ï¼Œçº¿ç¨‹ä¸ºåŒä¸€çº¿ç¨‹ã€‚
```







### è‹¹æœç”¨ RunLoop å®ç°çš„åŠŸèƒ½

App å¯åŠ¨å RunLoop çš„çŠ¶æ€ï¼Œç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†5ä¸ªMode:

1. kCFRunLoopDefaultMode: Appçš„é»˜è®¤ Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ª Mode ä¸‹è¿è¡Œçš„ã€‚
2. UITrackingRunLoopMode: ç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– Mode å½±å“ã€‚
3. UIInitializationRunLoopMode: åœ¨åˆšå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ã€‚
4. GSEventReceiveRunLoopMode: æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°ã€‚
5. kCFRunLoopCommonModes: è¿™æ˜¯ä¸€ä¸ªå ä½çš„ Modeï¼Œæ²¡æœ‰å®é™…ä½œç”¨ã€‚

å½“ RunLoop è¿›è¡Œå›è°ƒæ—¶ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°è°ƒç”¨å‡ºå» (call out), å½“ä½ åœ¨ä½ çš„ä»£ç ä¸­ä¸‹æ–­ç‚¹è°ƒè¯•æ—¶ï¼Œé€šå¸¸èƒ½åœ¨è°ƒç”¨æ ˆä¸Šçœ‹åˆ°è¿™äº›å‡½æ•°ã€‚ä¸‹é¢æ˜¯è¿™å‡ ä¸ªå‡½æ•°çš„æ•´ç†ç‰ˆæœ¬ï¼Œå¦‚æœä½ åœ¨è°ƒç”¨æ ˆä¸­çœ‹åˆ°è¿™äº›é•¿å‡½æ•°åï¼Œåœ¨è¿™é‡ŒæŸ¥æ‰¾ä¸€ä¸‹å°±èƒ½å®šä½åˆ°å…·ä½“çš„è°ƒç”¨åœ°ç‚¹äº†ï¼š

```
/// 1. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥RunLoop
/// æ­¤å¤„æœ‰Observerä¼šåˆ›å»ºAutoreleasePool: _objc_autoreleasePoolPush();
__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopEntry);
do {

/// 2. é€šçŸ¥ Observers: å³å°†è§¦å‘ Timer å›è°ƒã€‚
__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeTimers);

/// 3. é€šçŸ¥ Observers: å³å°†è§¦å‘ Source (éåŸºäºportçš„,Source0) å›è°ƒã€‚
__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeSources);
__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);

/// 4. è§¦å‘ Source0 (éåŸºäºportçš„) å›è°ƒã€‚
__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(source0);
__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);

/// 6. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥ä¼‘çœ 
/// æ­¤å¤„æœ‰Observeré‡Šæ”¾å¹¶æ–°å»ºAutoreleasePool: _objc_autoreleasePoolPop(); _objc_autoreleasePoolPush();
__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeWaiting);

/// 7. sleep to wait msg.
mach_msg() -> mach_msg_trap();

/// 8. é€šçŸ¥Observersï¼Œçº¿ç¨‹è¢«å”¤é†’
__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopAfterWaiting);

/// 9. å¦‚æœæ˜¯è¢«Timerå”¤é†’çš„ï¼Œå›è°ƒTimer
__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__(timer);

/// 9. å¦‚æœæ˜¯è¢«dispatchå”¤é†’çš„ï¼Œæ‰§è¡Œæ‰€æœ‰è°ƒç”¨ dispatch_async ç­‰æ–¹æ³•æ”¾å…¥main queue çš„ block
__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(dispatched_block);

/// 9. å¦‚æœå¦‚æœRunloopæ˜¯è¢« Source1 (åŸºäºportçš„) çš„äº‹ä»¶å”¤é†’äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶
__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__(source1);

} while (...);

/// 10. é€šçŸ¥Observersï¼Œå³å°†é€€å‡ºRunLoop
/// æ­¤å¤„æœ‰Observeré‡Šæ”¾AutoreleasePool: _objc_autoreleasePoolPop();
__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopExit);
```



#### AutoreleasePool

RunLoopå¼€å§‹çš„æ—¶å€™ï¼Œè‡ªåŠ¨é‡Šæ”¾æ± åˆ›å»ºã€å¯¹è±¡æ”¾å…¥è‡ªåŠ¨é‡Šæ”¾æ± ï¼ŒRunLoopè¿›å…¥ä¼‘çœ æˆ–è€…ç»“æŸçš„æ—¶å€™ è‡ªåŠ¨é‡Šæ”¾æ± é‡Šæ”¾å¹¶åˆ›å»ºæ–°çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªå¾ªç¯ã€‚

#### äº‹ä»¶å“åº”

UIEvent çš„å¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ« UIGesture/å¤„ç†å±å¹•æ—‹è½¬/å‘é€ç»™ UIWindow ç­‰ã€‚é€šå¸¸äº‹ä»¶æ¯”å¦‚ UIButton ç‚¹å‡»ã€touchesBegin/Move/End/Cancel äº‹ä»¶éƒ½æ˜¯ç›‘å¬å›è°ƒä¸­å®Œæˆçš„ï¼Œä¹Ÿæ˜¯runloopã€‚

#### æ‰‹åŠ¿è¯†åˆ«

å½“ä¸Šé¢çš„ _UIApplicationHandleEventQueue() è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ Cancel å°†å½“å‰çš„ touchesBegin/Move/End ç³»åˆ—å›è°ƒæ‰“æ–­ã€‚éšåç³»ç»Ÿå°†å¯¹åº”çš„ UIGestureRecognizer æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚

è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘æµ‹ BeforeWaiting (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶ï¼Œè¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯ _UIGestureRecognizerUpdateObserver()ï¼Œå…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ GestureRecognizerï¼Œå¹¶æ‰§è¡ŒGestureRecognizerçš„å›è°ƒã€‚

å½“æœ‰ UIGestureRecognizer çš„å˜åŒ–(åˆ›å»º/é”€æ¯/çŠ¶æ€æ”¹å˜)æ—¶ï¼Œè¿™ä¸ªå›è°ƒéƒ½ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚

#### ç•Œé¢æ›´æ–°

ç³»ç»Ÿæ³¨å†Œçš„ç›‘å¬è€…ï¼Œéå†æ‰€æœ‰å¾…å¤„ç†çš„ UIView/CAlayer ä»¥æ‰§è¡Œå®é™…çš„ç»˜åˆ¶å’Œè°ƒæ•´ï¼Œå¹¶æ›´æ–° UI ç•Œé¢ã€‚

#### å®šæ—¶å™¨

NSTimer å…¶å®å°±æ˜¯ CFRunLoopTimerRefï¼Œä»–ä»¬ä¹‹é—´æ˜¯ toll-free bridged çš„ã€‚ä¸€ä¸ª NSTimer æ³¨å†Œåˆ° RunLoop åï¼ŒRunLoop ä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå¥½äº‹ä»¶ã€‚ä¾‹å¦‚ 10:00, 10:10, 10:20 è¿™å‡ ä¸ªæ—¶é—´ç‚¹ã€‚RunLoopä¸ºäº†èŠ‚çœèµ„æºï¼Œå¹¶ä¸ä¼šåœ¨éå¸¸å‡†ç¡®çš„æ—¶é—´ç‚¹å›è°ƒè¿™ä¸ªTimerã€‚Timer æœ‰ä¸ªå±æ€§å«åš Tolerance (å®½å®¹åº¦)ï¼Œæ ‡ç¤ºäº†å½“æ—¶é—´ç‚¹åˆ°åï¼Œå®¹è®¸æœ‰å¤šå°‘æœ€å¤§è¯¯å·®ã€‚

#### PerformSelecter

å½“è°ƒç”¨ NSObject çš„ performSelecter:afterDelay: åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª Timer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ RunLoop ä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ RunLoopï¼Œåˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆã€‚

å½“è°ƒç”¨ performSelector:onThread: æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ª Timer åŠ åˆ°å¯¹åº”çš„çº¿ç¨‹å»ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰ RunLoop è¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆã€‚

#### GCD

å½“è°ƒç”¨ dispatch_async(dispatch_get_main_queue(), block) æ—¶ï¼ŒlibDispatch ä¼šå‘ä¸»çº¿ç¨‹çš„ RunLoop å‘é€æ¶ˆæ¯ï¼ŒRunLoopä¼šè¢«å”¤é†’ï¼Œå¹¶ä»æ¶ˆæ¯ä¸­å–å¾—è¿™ä¸ª blockï¼Œå¹¶åœ¨å›è°ƒ __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__() é‡Œæ‰§è¡Œè¿™ä¸ª blockã€‚ä½†è¿™ä¸ªé€»è¾‘ä»…é™äº dispatch åˆ°ä¸»çº¿ç¨‹ï¼Œdispatch åˆ°å…¶ä»–çº¿ç¨‹ä»ç„¶æ˜¯ç”± libDispatch å¤„ç†çš„ã€‚



#### ç½‘ç»œè¯·æ±‚







å‚è€ƒ:

[æ·±å…¥ç†è§£runloop](https://blog.ibireme.com/2015/05/18/runloop/)

[iOS RunLoopå…¥é—¨å°ç»“](https://www.jianshu.com/p/18afd628ac43)

[Objective-Cä¹‹run loopè¯¦è§£](http://blog.csdn.net/wzzvictory/article/details/9237973 http://www.cocoachina.com/ios/20150601/11970.html)







## è¦ç›‘å¬RunLoopçš„çŠ¶æ€ä»NSRunLoopä¸­è·å–ä¸åˆ°ä»»ä½•ä¸Observerç›¸å…³çš„ä¿¡æ¯,æ›´ä¸ç”¨è¯´ç›‘å¬äº†.è¿™æ—¶å€™å°±éœ€è¦ä»CFRunLoopRefå…¥æ‰‹äº†.(è¿™è¾¹æˆ‘ä»¬ç›‘å¬çš„æ˜¯ä¸»çº¿ç¨‹çš„RunLoop,ç›‘å¬RunLoopçš„çŠ¶æ€å˜åŒ–å¯ä»¥ç”¨äºä¼˜åŒ–ç¨‹åº,æ¯”å¦‚è¡¨æ ¼è¦åŠ è½½å¤§é‡æ•°æ®,å›¾ç‰‡,å¤„ç†è€—æ—¶æ“ä½œ,ä¼šé€ æˆUIå¡é¡¿,è¿™æ—¶å°±å¯ä»¥åˆ©ç”¨ç›‘å¬RunLoop,åœ¨ä»–ä¼‘çœ æ—¶å”¤é†’å®ƒå»å¤„ç†è¿™äº›ä»»åŠ¡,ä¾‹å­è¿™è¾¹å°±ä¸ä¸¾äº†ğŸ˜˜)

## ç‚¹å‡»CFRunLoopRefåˆ°APIä¸­å‘ç°å®šä¹‰äº†Observerçš„ç›¸å…³å£°æ˜CFRunLoopObserverRef,è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ğŸ˜˜:

```
typedef struct CF_BRIDGED_MUTABLE_TYPE(id) __CFRunLoop * CFRunLoopRef;

typedef struct CF_BRIDGED_MUTABLE_TYPE(id) __CFRunLoopSource * CFRunLoopSourceRef;

typedef struct CF_BRIDGED_MUTABLE_TYPE(id) __CFRunLoopObserver * CFRunLoopObserverRef;

typedef struct CF_BRIDGED_MUTABLE_TYPE(NSTimer) __CFRunLoopTimer * CFRunLoopTimerRef;
```

### æ‰¾åˆ°äº†CFRunLoopObserverRefä¹‹åå°±æ˜¯è¦åˆ›å»ºä¸€ä¸ªObserveräº†,åœ¨APIä¸­æ‰¾åˆ°å¦‚ä¸‹å‡½æ•°å£°æ˜:

```
CF_EXPORT CFRunLoopObserverRef CFRunLoopObserverCreate(CFAllocatorRef allocator, CFOptionFlags activities, Boolean repeats, CFIndex order, CFRunLoopObserverCallBack callout, CFRunLoopObserverContext *context);
```

### è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„åˆ›å»ºOBserverçš„æ–¹æ³•ğŸ˜˜,çœ‹çœ‹å®ƒéœ€è¦çš„å‚æ•°:

- ## CFAllocatorRef allocator è¿™ä¸ªé¼ æ ‡å‡½æ•°çš„æ—¶å€™Xcodeå³è¾¹è§£é‡Šäº†ä¸€å †(æš‚æ—¶æ¯é¸¡ä»–çš„ç”¨æ³•)

- ## CFOptionFlags activities è¡¨ç¤ºè¦ç›‘å¬RunLoopçš„å˜åŒ–çš„çŠ¶æ€(kCFRunLoopAfterWaitingç­‰)

- ## Boolean repeats//è¡¨ç¤ºæ˜¯å¦é‡å¤ç›‘å¬

- ## CFIndex order è¿™ä¸ªä¼ 0å³å¯æš‚æ—¶æ²¡ç ”ç©¶

- ## CFRunLoopObserverCallBack callout è¡¨ç¤ºç›‘å¬çš„å›è°ƒæ–¹æ³•(Cè¯­è¨€çš„æ–¹æ³•)

- ## CFRunLoopObserverContext *context è¡¨ç¤ºä¸Šä¸‹æ–‡ç¯å¢ƒ,ç”¨äºCè¯­è¨€çš„æ–¹æ³•ä¸OCçš„äº’ä¼ ä¼ å€¼

### æ—¢ç„¶å¦‚æ­¤ç°åœ¨æ¥åˆ›å»ºä¸€ä¸ªCFRunLoopObserverContext,åœ¨APIä¸­ä¹Ÿæ‰¾åˆ°ä¸€ä¸ªCFRunLoopObserverContextçš„å£°æ˜

```
typedef struct {
    CFIndex version; //æš‚æ—¶ä¼ 0ä¸ç ”ç©¶
    void *  info; //é‡è¦å°±æ˜¯Cè¯­è¨€è¦ä¸OCä¼ é€’æ•°æ®çš„å¼•ç”¨.void *è¡¨ç¤ºå¯ä»¥ä¼ é€’ä»»ä½•ç±»å‹çš„æ•°æ®
    const void *(*retain)(const void *info);//å¼•ç”¨
    void    (*release)(const void *info);//å›æ”¶
    CFStringRef (*copyDescription)(const void *info);//æè¿°,æš‚æ—¶æ²¡ç”¨
} CFRunLoopObserverContext;
```

### ç°åœ¨åˆ›å»ºä¸€ä¸ªCFRunLoopObserverContext

```
CFRunLoopObserverContext context =  {
        0,
        (__bridge void *)(self),//OCå¯¹è±¡ä¼ é€’è¿‡å»
        &CFRetain,
        &CFRelease,
        NULL
    };
```

### ç‚¹å‡»ä¸Šé¢çš„CFRunLoopObserverCallBackæ˜¯APIè·³åˆ°è¿™æ ·çš„ä¸€ä¸ªå£°æ˜,å³å‘Šè¯‰æˆ‘ä»¬ç›‘å¬çš„å›è°ƒæ–¹æ³•çš„å‚æ•°æ€ä¹ˆå®šä¹‰

```
typedef void (*CFRunLoopObserverCallBack)(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info);
```

### æ¥ä¸‹æ¥æ–°å»ºä¸€ä¸ªCè¯­è¨€ç”¨äºå›è°ƒæ–¹æ³•

```
static void runLoopOserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info){
   //void *infoæ­£æ˜¯æˆ‘ä»¬è¦ç”¨æ¥ä¸OCä¼ å€¼çš„,è¿™è¾¹å¯ä»¥è½¬æˆOCå¯¹è±¡,å‰é¢æˆ‘ä»¬ä¼ è¿›æ¥çš„æ—¶å€™æ˜¯self
}
```

### åˆ°è¿™è¾¹ä¸‡äº‹ä¿±å¤‡äº†ğŸ˜˜,å¯ä»¥åˆ›å»ºobserveräº†

```
//åˆ›å»ºä¸€ä¸ªç›‘å¬
    static CFRunLoopObserverRef observer;
    observer = CFRunLoopObserverCreate(NULL, kCFRunLoopAfterWaiting, YES, 0, &runLoopOserverCallBack,&context);
    //æ³¨å†Œç›‘å¬
    CFRunLoopAddObserver(runLoopRef, observer, kCFRunLoopCommonModes);
    //é”€æ¯
    CFRelease(observer);
```

### åˆ°æ­¤ç»“æŸğŸ˜˜,å®Œæ•´ä»£ç å¦‚ä¸‹:

###### ä¸ºäº†è®©RunLoopä¸€ç›´å·¥ä½œ,è¿™è¾¹æ·»åŠ äº†ä¸€ä¸ªNSTimer,ä¸è¿‡ä»–ä»€ä¹ˆéƒ½æ²¡åš,åªæ˜¯ä¸ºäº†è®©RunLoopä¸€ç›´å·¥ä½œ

```
@interface ViewController ()

@property (nonatomic, strong)NSTimer *runLoopObServerTimer;
@property (nonatomic, copy)NSString
 *name;

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self addRunLoopObserver];
    [self initData];
}

- (void)initData{
    _name = @"piaojin";
    //é»˜è®¤ä¼šæ·»åŠ åˆ°å½“å‰çš„runLoopä¸­å»,ä¸åšä»»ä½•äº‹æƒ…,ä¸ºäº†è®©runLoopä¸€ç›´å¤„ç†ä»»åŠ¡è€Œä¸å»ç¡çœ 
    _runLoopObServerTimer = [NSTimer scheduledTimerWithTimeInterval:0.001 target:self selector:@selector(timerMethod) userInfo:nil repeats:YES];
}

- (void)addRunLoopObserver{
    //è·å–å½“å‰çš„CFRunLoopRef
    CFRunLoopRef runLoopRef = CFRunLoopGetCurrent();
    //åˆ›å»ºä¸Šä¸‹æ–‡,ç”¨äºæ§åˆ¶å™¨æ•°æ®çš„è·å–
    CFRunLoopObserverContext context =  {
        0,
        (__bridge void *)(self),//selfä¼ é€’è¿‡å»
        &CFRetain,
        &CFRelease,
        NULL
    };
    //åˆ›å»ºä¸€ä¸ªç›‘å¬
    static CFRunLoopObserverRef observer;
    observer = CFRunLoopObserverCreate(NULL, kCFRunLoopAfterWaiting, YES, 0, &runLoopOserverCallBack,&context);
    //æ³¨å†Œç›‘å¬
    CFRunLoopAddObserver(runLoopRef, observer, kCFRunLoopCommonModes);
    //é”€æ¯
    CFRelease(observer);
}

//ç›‘å¬CFRunLoopRefå›è°ƒå‡½æ•°
static void runLoopOserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info){
    ViewController *viewController = (__bridge ViewController *)(info);//void *infoå³æ˜¯æˆ‘ä»¬å‰é¢ä¼ é€’çš„self(ViewController)
    
    NSLog(@"runLoopOserverCallBack -> name = %@",viewController.name);
}

- (void)timerMethod{
    //ä¸åšä»»ä½•äº‹æƒ…,ä¸ºäº†è®©runLoopä¸€ç›´å¤„ç†ä»»åŠ¡è€Œä¸å»ç¡çœ 
}
@end
```

### è‡³æ­¤å½“å‰çš„RunLoopä¸€å½“è¿›å…¥ä¼‘çœ åéƒ½ä¼šè¢«ç›‘å¬åˆ°å¹¶ä¸”è°ƒç”¨runLoopOserverCallBackå›è°ƒæ–¹æ³•



å®éªŒ



```

#import "ViewController.h"

@interface ViewController ()
    @property (nonatomic, strong)NSTimer *runLoopObServerTimer;
    @property (nonatomic, copy) NSString *name;
@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self addRunLoopObserver];
    [self initData];
}

- (void)initData{
    _name = @"Test";
    //é»˜è®¤ä¼šæ·»åŠ åˆ°å½“å‰çš„runLoopä¸­å»,ä¸åšä»»ä½•äº‹æƒ…,ä¸ºäº†è®©runLoopä¸€ç›´å¤„ç†ä»»åŠ¡è€Œä¸å»ç¡çœ 
//    _runLoopObServerTimer = [NSTimer scheduledTimerWithTimeInterval:0.001 target:self selector:@selector(timerMethod) userInfo:nil repeats:YES];
}
    
- (void)addRunLoopObserver{
    //è·å–å½“å‰çš„CFRunLoopRef
    CFRunLoopRef runLoopRef = CFRunLoopGetCurrent();
    //åˆ›å»ºä¸Šä¸‹æ–‡,ç”¨äºæ§åˆ¶å™¨æ•°æ®çš„è·å–
    CFRunLoopObserverContext context =  {
        0,
        (__bridge void *)(self),//selfä¼ é€’è¿‡å»
        &CFRetain,
        &CFRelease,
        NULL
    };
    //åˆ›å»ºä¸€ä¸ªç›‘å¬
    static CFRunLoopObserverRef observer;
    observer = CFRunLoopObserverCreate(NULL, kCFRunLoopBeforeWaiting, YES, 0, &runLoopOserverCallBack,&context);
    //æ³¨å†Œç›‘å¬
    CFRunLoopAddObserver(runLoopRef, observer, kCFRunLoopCommonModes);
    //é”€æ¯
    CFRelease(observer);
    
    
    //åˆ›å»ºä¸€ä¸ªç›‘å¬
    static CFRunLoopObserverRef observer2;
    observer2 = CFRunLoopObserverCreate(NULL, kCFRunLoopAfterWaiting, YES, 0, &wakeupRunLoopOserverCallBack,&context);
    //æ³¨å†Œç›‘å¬
    CFRunLoopAddObserver(runLoopRef, observer2, kCFRunLoopCommonModes);
    //é”€æ¯
    CFRelease(observer2);
}
    
    //ç›‘å¬CFRunLoopRefå›è°ƒå‡½æ•°
    static void runLoopOserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info){
        NSLog(@"runLoopOserverCallBack -> name = kCFRunLoopBeforeWaiting - %@", CFRunLoopGetCurrent());
    }

    static void wakeupRunLoopOserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info){
        NSLog(@"runLoopOserverCallBack -> name = kCFRunLoopAfterWaiting - %@", CFRunLoopGetCurrent());
    }
    
- (void)timerMethod{
    //ä¸åšä»»ä½•äº‹æƒ…,ä¸ºäº†è®©runLoopä¸€ç›´å¤„ç†ä»»åŠ¡è€Œä¸å»ç¡çœ 
}
    
- (IBAction)actionOne:(id)sender {
    for (int index = 0; index < 1000; index++) {
        sleep(1);
        NSLog(@"%d", index);
    }
}
    
- (IBAction)actionTwo:(id)sender {
    printf("actionTwo");
}
    
- (IBAction)actionThree:(id)sender {
    for (int index = 0; index < 1000; index++) {
        sleep(1);
        NSLog(@"%d", index);
    }
}
    
- (IBAction)actionFour:(id)sender {
    printf("actionFour");
}
    

@end

```

ç»“æœåˆ†æ



```
ç›‘å¬è¿™ä¸€éƒ¨åˆ†
typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
    kCFRunLoopEntry         = (1UL << 0), // å³å°†è¿›å…¥Loop
    kCFRunLoopBeforeTimers  = (1UL << 1), // å³å°†å¤„ç† Timer
    kCFRunLoopBeforeSources = (1UL << 2), // å³å°†å¤„ç† Source
    kCFRunLoopBeforeWaiting = (1UL << 5), // å³å°†è¿›å…¥ä¼‘çœ 
    kCFRunLoopAfterWaiting  = (1UL << 6), // åˆšä»ä¼‘çœ ä¸­å”¤é†’
    kCFRunLoopExit          = (1UL << 7), // å³å°†é€€å‡ºLoop
};

åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™å¯ä»¥çœ‹è§åˆå§‹åŒ–æ„å»ºçš„runloopï¼Œä¹Ÿå°±æ˜¯å‰é¢è¯´çš„ç³»ç»Ÿåˆ›å»ºçš„é»˜è®¤loop

ä»”ç»†åˆ†ææ¯ä¸€ä¸ªloopå¯ä»¥äº†è§£loop


å¾ªç¯éƒ¨åˆ†ï¼š

1ã€å½“ä¸è§¦æ‘¸è®¾å¤‡ï¼Œè®¾å¤‡ä¸€åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡è¿è¡Œå¾ªç¯

2ã€å½“ç”¨æˆ·äº‹ä»¶å“åº”ï¼Œæ¯”å¦‚ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®ï¼Œå°±ä¼šå®Œæˆä¸€æ¬¡å¾ªç¯ï¼Œä»å”¤é†’ åˆ° å†æ¬¡è¿›å…¥ä¼‘çœ 

3ã€æŒ‰ç†æ¥è¯´ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šè§¦å‘è‡ªåŠ¨é‡Šæ”¾æ± 

4ã€å¦‚æœæœ‰å…´è¶£å¯ä»¥åˆ†æä¸€ä¸‹æ‰“å°å‡ºæ¥çš„loopï¼Œå¯ä»¥æ›´è¯¦ç»†çŸ¥é“loopé‡Œéƒ½æœ‰å•¥

```

åˆ†æä¸€ä¸ªloop

```
Runloop[410:85317] runLoopOserverCallBack -> 

//æˆ‘ä»¬ç›‘å¬çš„loop - kCFRunLoopBeforeWaiting
name = kCFRunLoopBeforeWaiting - <CFRunLoop 0x170160900 [0x1b843cbb8]>{wakeup port = 0x1e03, stopped = false, ignoreWakeUps = false, 

//loop mode
current mode = kCFRunLoopDefaultMode,

//ä¸¤ä¸ªå…¬å¼€çš„common modes
common modes = <CFBasicHash 0x17004bfa0 [0x1b843cbb8]>{type = mutable set, count = 2,
entries =>
	0 : <CFString 0x1b2d00970 [0x1b843cbb8]>{contents = "UITrackingRunLoopMode"}
	2 : <CFString 0x1b22484b0 [0x1b843cbb8]>{contents = "kCFRunLoopDefaultMode"}
}

//æ‰€æœ‰çš„ common mode itemsï¼ŒåŒ…å«sourceã€timerã€observer
common mode items = <CFBasicHash 0x17004beb0 [0x1b843cbb8]>{type = mutable set, count = 18,
entries =>
	0 : <CFRunLoopSource 0x170160d80 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 0, info = 0x0, callout = <redacted> (0x193c0bb5c)}}
	2 : <CFRunLoopSource 0x170162040 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 0, info = 0x170126400, callout = <redacted> (0x198bec0d0)}}
	3 : <CFRunLoopObserver 0x170126360 [0x1b843cbb8]>{valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = <redacted> (0x1983eb200), context = <CFRunLoopObserver context 0x1700dbeb0>}
	4 : <CFRunLoopSource 0x170162c40 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 25095, subsystem = 0x1b2cdd600, context = 0x170033140}}
	5 : <CFRunLoopSource 0x170163540 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 27143, subsystem = 0x1b256bf90, context = 0x1700b68c0}}
	7 : <CFRunLoopObserver 0x1701260e0 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = <redacted> (0x198698c20), context = <CFRunLoopObserver context 0x100201710>}
	8 : <CFRunLoopSource 0x170160f00 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 1, info = 0x3703, callout = <redacted> (0x193c0e370)}}
	9 : <CFRunLoopObserver 0x170125fa0 [0x1b843cbb8]>{valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = <redacted> (0x1983eb38c), context = <CFArray 0x17004e640 [0x1b843cbb8]>{type = mutable-small, count = 1, values = (
	0 : <0x1001f0048>
)}}
	10 : <CFRunLoopObserver 0x170125f00 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = <redacted> (0x1983eb38c), context = <CFArray 0x17004e640 [0x1b843cbb8]>{type = mutable-small, count = 1, values = (
	0 : <0x1001f0048>
)}}
	11 : <CFRunLoopObserver 0x170126040 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = <redacted> (0x1983eb208), context = <CFRunLoopObserver context 0x100201710>}
	12 : <CFRunLoopSource 0x170161c80 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 22023, subsystem = 0x1b2cc6ba0, context = 0x0}}
	13 : <CFRunLoopSource 0x170160b40 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFMachPort 0x1701488d0 [0x1b843cbb8]>{valid = Yes, port = 1a03, source = 0x170160b40, callout = <redacted> (0x1954dbebc), context = <CFMachPort context 0x0>}}
	14 : <CFRunLoopSource 0x174161380 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource context>{version = 0, info = 0x174069040, callout = <redacted> (0x193e6ff34)}}
	15 : <CFRunLoopSource 0x174160cc0 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFMachPort 0x174148770 [0x1b843cbb8]>{valid = Yes, port = 2203, source = 0x174160cc0, callout = <redacted> (0x1954dbfc8), context = <CFMachPort context 0x0>}}
	16 : <CFRunLoopSource 0x170161740 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -2, context = <CFRunLoopSource context>{version = 0, info = 0x17004bd90, callout = <redacted> (0x198bed514)}}
	17 : <CFRunLoopObserver 0x174125aa0 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = <redacted> (0x19557de00), context = <CFRunLoopObserver context 0x0>}
	18 : <CFRunLoopObserver 0x170125be0 [0x1b843cbb8]>{valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = runLoopOserverCallBack (0x10002e1fc), context = <CFRunLoopObserver context 0x100208a80>}
	19 : <CFRunLoopObserver 0x170125b40 [0x1b843cbb8]>{valid = Yes, activities = 0x40, repeats = Yes, order = 0, callout = enterRunLoopOserverCallBack (0x10002e238), context = <CFRunLoopObserver context 0x100208a80>}
}
,
modes = <CFBasicHash 0x17004bb80 [0x1b843cbb8]>{type = mutable set, count = 5,
entries =>
	2 : <CFRunLoopMode 0x170190cf0 [0x1b843cbb8]>{name = UITrackingRunLoopMode, port set = 0x2303, queue = 0x170160cc0, source = 0x1701d88d0 (not fired), timer port = 0x2503, 
	sources0 = <CFBasicHash 0x17004ccf0 [0x1b843cbb8]>{type = mutable set, count = 4,
entries =>
	0 : <CFRunLoopSource 0x170160d80 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 0, info = 0x0, callout = <redacted> (0x193c0bb5c)}}
	2 : <CFRunLoopSource 0x174161380 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource context>{version = 0, info = 0x174069040, callout = <redacted> (0x193e6ff34)}}
	3 : <CFRunLoopSource 0x170161740 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -2, context = <CFRunLoopSource context>{version = 0, info = 0x17004bd90, callout = <redacted> (0x198bed514)}}
	6 : <CFRunLoopSource 0x170162040 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 0, info = 0x170126400, callout = <redacted> (0x198bec0d0)}}
}
,
	sources1 = <CFBasicHash 0x17004ccc0 [0x1b843cbb8]>{type = mutable set, count = 6,
entries =>
	0 : <CFRunLoopSource 0x174160cc0 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFMachPort 0x174148770 [0x1b843cbb8]>{valid = Yes, port = 2203, source = 0x174160cc0, callout = <redacted> (0x1954dbfc8), context = <CFMachPort context 0x0>}}
	1 : <CFRunLoopSource 0x170161c80 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 22023, subsystem = 0x1b2cc6ba0, context = 0x0}}
	2 : <CFRunLoopSource 0x170160b40 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFMachPort 0x1701488d0 [0x1b843cbb8]>{valid = Yes, port = 1a03, source = 0x170160b40, callout = <redacted> (0x1954dbebc), context = <CFMachPort context 0x0>}}
	3 : <CFRunLoopSource 0x170162c40 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 25095, subsystem = 0x1b2cdd600, context = 0x170033140}}
	4 : <CFRunLoopSource 0x170163540 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 27143, subsystem = 0x1b256bf90, context = 0x1700b68c0}}
	6 : <CFRunLoopSource 0x170160f00 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 1, info = 0x3703, callout = <redacted> (0x193c0e370)}}
}
,
	observers = (
    "<CFRunLoopObserver 0x170125fa0 [0x1b843cbb8]>{valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = <redacted> (0x1983eb38c), context = <CFArray 0x17004e640 [0x1b843cbb8]>{type = mutable-small, count = 1, values = (\n\t0 : <0x1001f0048>\n)}}",
    "<CFRunLoopObserver 0x170126360 [0x1b843cbb8]>{valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = <redacted> (0x1983eb200), context = <CFRunLoopObserver context 0x1700dbeb0>}",
    "<CFRunLoopObserver 0x170125be0 [0x1b843cbb8]>{valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = runLoopOserverCallBack (0x10002e1fc), context = <CFRunLoopObserver context 0x100208a80>}",
    "<CFRunLoopObserver 0x170125b40 [0x1b843cbb8]>{valid = Yes, activities = 0x40, repeats = Yes, order = 0, callout = enterRunLoopOserverCallBack (0x10002e238), context = <CFRunLoopObserver context 0x100208a80>}",
    "<CFRunLoopObserver 0x1701260e0 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = <redacted> (0x198698c20), context = <CFRunLoopObserver context 0x100201710>}",
    "<CFRunLoopObserver 0x174125aa0 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = <redacted> (0x19557de00), context = <CFRunLoopObserver context 0x0>}",
    "<CFRunLoopObserver 0x170126040 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = <redacted> (0x1983eb208), context = <CFRunLoopObserver context 0x100201710>}",
    "<CFRunLoopObserver 0x170125f00 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = <redacted> (0x1983eb38c), context = <CFArray 0x17004e640 [0x1b843cbb8]>{type = mutable-small, count = 1, values = (\n\t0 : <0x1001f0048>\n)}}"
),
	timers = (null),
	currently 583385583 (550429779819) / soft deadline in: 7.68614313e+11 sec (@ -1) / hard deadline in: 7.68614313e+11 sec (@ -1)
},

	3 : <CFRunLoopMode 0x170190dc0 [0x1b843cbb8]>{name = GSEventReceiveRunLoopMode, port set = 0x3103, queue = 0x170160e40, source = 0x1701d8c90 (not fired), timer port = 0x3503, 
	sources0 = <CFBasicHash 0x17004cab0 [0x1b843cbb8]>{type = mutable set, count = 1,
entries =>
	0 : <CFRunLoopSource 0x170160d80 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 0, info = 0x0, callout = <redacted> (0x193c0bb5c)}}
}
,
	sources1 = <CFBasicHash 0x17004b730 [0x1b843cbb8]>{type = mutable set, count = 1,
entries =>
	1 : <CFRunLoopSource 0x170160fc0 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 1, info = 0x3703, callout = <redacted> (0x193c0e370)}}
}
,
	observers = (null),
	timers = (null),
	currently 583385583 (550429807896) / soft deadline in: 7.68614313e+11 sec (@ -1) / hard deadline in: 7.68614313e+11 sec (@ -1)
},

	4 : <CFRunLoopMode 0x170190c20 [0x1b843cbb8]>{name = kCFRunLoopDefaultMode, port set = 0x1f03, queue = 0x170160c00, source = 0x1701d86f0 (not fired), timer port = 0x2103, 
	sources0 = <CFBasicHash 0x17004bee0 [0x1b843cbb8]>{type = mutable set, count = 4,
entries =>
	0 : <CFRunLoopSource 0x170160d80 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 0, info = 0x0, callout = <redacted> (0x193c0bb5c)}}
	2 : <CFRunLoopSource 0x174161380 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource context>{version = 0, info = 0x174069040, callout = <redacted> (0x193e6ff34)}}
	3 : <CFRunLoopSource 0x170161740 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -2, context = <CFRunLoopSource context>{version = 0, info = 0x17004bd90, callout = <redacted> (0x198bed514)}}
	6 : <CFRunLoopSource 0x170162040 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 0, info = 0x170126400, callout = <redacted> (0x198bec0d0)}}
}
,
	sources1 = <CFBasicHash 0x17004bf10 [0x1b843cbb8]>{type = mutable set, count = 6,
entries =>
	0 : <CFRunLoopSource 0x174160cc0 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFMachPort 0x174148770 [0x1b843cbb8]>{valid = Yes, port = 2203, source = 0x174160cc0, callout = <redacted> (0x1954dbfc8), context = <CFMachPort context 0x0>}}
	1 : <CFRunLoopSource 0x170161c80 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 22023, subsystem = 0x1b2cc6ba0, context = 0x0}}
	2 : <CFRunLoopSource 0x170160b40 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFMachPort 0x1701488d0 [0x1b843cbb8]>{valid = Yes, port = 1a03, source = 0x170160b40, callout = <redacted> (0x1954dbebc), context = <CFMachPort context 0x0>}}
	3 : <CFRunLoopSource 0x170162c40 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 25095, subsystem = 0x1b2cdd600, context = 0x170033140}}
	4 : <CFRunLoopSource 0x170163540 [0x1b843cbb8]>{signalled = No, valid = Yes, order = 0, context = <CFRunLoopSource MIG Server> {port = 27143, subsystem = 0x1b256bf90, context = 0x1700b68c0}}
	6 : <CFRunLoopSource 0x170160f00 [0x1b843cbb8]>{signalled = No, valid = Yes, order = -1, context = <CFRunLoopSource context>{version = 1, info = 0x3703, callout = <redacted> (0x193c0e370)}}
}
,
	observers = (
    "<CFRunLoopObserver 0x170125fa0 [0x1b843cbb8]>{valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = <redacted> (0x1983eb38c), context = <CFArray 0x17004e640 [0x1b843cbb8]>{type = mutable-small, count = 1, values = (\n\t0 : <0x1001f0048>\n)}}",
    "<CFRunLoopObserver 0x170126360 [0x1b843cbb8]>{valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = <redacted> (0x1983eb200), context = <CFRunLoopObserver context 0x1700dbeb0>}",
    "<CFRunLoopObserver 0x170125be0 [0x1b843cbb8]>{valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = runLoopOserverCallBack (0x10002e1fc), context = <CFRunLoopObserver context 0x100208a80>}",
    "<CFRunLoopObserver 0x170125b40 [0x1b843cbb8]>{valid = Yes, activities = 0x40, repeats = Yes, order = 0, callout = enterRunLoopOserverCallBack (0x10002e238), context = <CFRunLoopObserver context 0x100208a80>}",
    "<CFRunLoopObserver 0x1701260e0 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = <redacted> (0x198698c20), context = <CFRunLoopObserver context 0x100201710>}",
    "<CFRunLoopObserver 0x174125aa0 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = <redacted> (0x19557de00), context = <CFRunLoopObserver context 0x0>}",
    "<CFRunLoopObserver 0x170126040 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = <redacted> (0x1983eb208), context = <CFRunLoopObserver context 0x100201710>}",
    "<CFRunLoopObserver 0x170125f00 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = <redacted> (0x1983eb38c), context = <CFArray 0x17004e640 [0x1b843cbb8]>{type = mutable-small, count = 1, values = (\n\t0 : <0x1001f0048>\n)}}"
),
	timers = <CFArray 0x1700b7160 [0x1b843cbb8]>{type = mutable-small, count = 1, values = (
	0 : <CFRunLoopTimer 0x170161980 [0x1b843cbb8]>{valid = Yes, firing = No, interval = 0, tolerance = 0, next fire date = 583385584 (1.42843509 @ 550464141622), callout = (Delayed Perform) UIApplication _accessibilitySetUpQuickSpeak (0x192da4ab4 / 0x19847d798) (/System/Library/Frameworks/UIKit.framework/UIKit), context = <CFRunLoopTimer context 0x1700734c0>}
)},
	currently 583385583 (550429808814) / soft deadline in: 1.43053363 sec (@ 550464141622) / hard deadline in: 1.43053358 sec (@ 550464141622)
},

	5 : <CFRunLoopMode 0x174191100 [0x1b843cbb8]>{name = UIInitializationRunLoopMode, port set = 0x3907, queue = 0x174161440, source = 0x1741d8ab0 (not fired), timer port = 0x3c03, 
	sources0 = <CFBasicHash 0x17404c450 [0x1b843cbb8]>{type = mutable set, count = 1,
entries =>
	1 : <CFRunLoopSource 0x174161380 [0x1b843cbb8]>{signalled = Yes, valid = Yes, order = 0, context = <CFRunLoopSource context>{version = 0, info = 0x174069040, callout = <redacted> (0x193e6ff34)}}
}
,
	sources1 = <CFBasicHash 0x17404c480 [0x1b843cbb8]>{type = mutable set, count = 0,
entries =>
}
,
	observers = (
    "<CFRunLoopObserver 0x174125aa0 [0x1b843cbb8]>{valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = <redacted> (0x19557de00), context = <CFRunLoopObserver context 0x0>}"
),
	timers = (null),
	currently 583385583 (550429860089) / soft deadline in: 7.68614313e+11 sec (@ -1) / hard deadline in: 7.68614313e+11 sec (@ -1)
},

	6 : <CFRunLoopMode 0x1741911d0 [0x1b843cbb8]>{name = kCFRunLoopCommonModes, port set = 0x5707, queue = 0x174161980, source = 0x1741d8c90 (not fired), timer port = 0x5803, 
	sources0 = (null),
	sources1 = (null),
	observers = (null),
	timers = (null),
	currently 583385583 (550429861924) / soft deadline in: 7.68614313e+11 sec (@ -1) / hard deadline in: 7.68614313e+11 sec (@ -1)
},

}
}
```

