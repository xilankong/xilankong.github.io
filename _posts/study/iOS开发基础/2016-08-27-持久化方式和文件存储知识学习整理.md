---
layout: post
category: iOS开发基础
title : "持久化方式和文件存储知识学习整理"
---

> 
>
> 
>
> 
>
> 
>
> 出于安全考虑，iOS系统的沙盒机制规定每个应用都只能访问当前沙盒目录下面的文件（也有例外，比如在用户授权情况下访问通讯录，相册等），这个规则展示了iOS系统的封闭性。
>
> 在应用开发中，如果要保存沙盒中某个文件路径，注意不要保存全路径，只能保存在沙盒中的相对路径，否则会导致路径访问错误。这是因为每次重新编译安装应用时，沙盒目录路径会改变。以下是对每个文件夹的作用进行说明：

### iOS持久化方式有哪些

首先这里的持久化指的是数据持久化，目前客户端的持久化也只有这一个含义。
为何要持久化：iOS开发可以没有持久化，持久化更多的是业务需求；比如记录用户是否登陆，下次进应用不需要再登陆。
因为iOS的沙盒机制，所以持久化分为两类：沙盒内和沙盒外。

##### 沙盒内

###### NSKeyedArchiver

只要遵循了NSCoding协议并正确实现了initWithCoder和encodeWithCoder方法的类都可以通过NSKeyedArchiver来序列化。
归档使用archiveRootObject，解归档使用unarchiveObjectWithFile；需要指定文件路径。

###### NSUserDefaults

[NSUserDefaults standardUserDefaults]获取NSUserDefaults对象，以key-value方式进行持久化操作。

###### plist

写入使用writeToFile，读取使用xxxWithContentsOfFile；需要指定文件路径。

###### 数据库

数据库无疑是大量数据最好的持久化方案，数据库目前有：sqlite、CoreData和Realm等。这里就不用回答FMDB它只是封装了sqlite而已。

###### 文件

这里要和plist区分一下，plist方式是字典/数组数据格式写入文件；而这里的文件方式不限数据格式。

##### 沙盒外

###### KeyChain

沙盒内的方式在应用被删除后数据都会丢失，如果想要不丢失则需要使用KeyChain。
KeyChain本质是一个sqlite数据库，其保存的所有数据都是加密过的。
KeyChain分为私有和公有，公有则需要指定group，一个group中的应用可以共享此KeyChain。
使用KeyChain过程中要理解下面几个问题：

```
1：自己使用的KeyChain和系统自带的KeyChain数据是隔离的，内部应该是不同数据库文件；
2：KeyChain数据可备份到iCloud中；
3：不需要联网，也不用登陆iCloud账号；一个设备一个sqlite数据库，但是不同应用组不共享数据；
4：要在另一台设备上使用当前设备存储的KeyChain信息，需要当前设备进行数据备份，
再在另一设备上复原数据；比较常用的是iCloud备份方式；
5：系统自带的KeyChain中账号密码分类数据可在系统设置->账号与密码里面看到，
你退出iCloud账号还是存在，只是iCloud会帮你备份如果你设置了的话；这个和照片是一样的道理。
```



### 一、沙盒目录结构

![](https://xilankong.github.io/resource/ios_app_file.png)

```
AppName.app :  应用程序包目录，包含应用程序和所需资源。由于应用程序必须经过签名，所以您在运行时不能对这个目录中的内容进行修改，否则可能会使应用程序无法启动。

Documents：您应该将所有的应用程序数据文件写入到这个目录下。这个目录用于存储用户数据。该路径可通过配置实现iTunes共享文件。会被iTunes同步。

Documents/Inbox：用来存放由外部应用请求当前应用程序打开的文件，会被iTunes同步。

Library：下面有两个目录，该路径下的文件夹，除Caches以外，都会被iTunes备份。

Preferences：包含应用程序的偏好设置文件。您不应该直接创建偏好设置文件，而是应该使用NSUserDefaults类来取得和设置应用程序的偏好。结果在目录下面以plist的方式存储

Caches：用于存放应用程序专用的支持文件，保存应用程序再次启动过程中需要的信息。可创建子文件夹。可以用来放置您希望被备份但不希望被用户看到的数据。

tmp：用来存放应用再次启动时不需要的临时文件，该目录下的东西随时可能被系统清理掉，不会被iTunes同步。

```

### 二、获取沙盒各个路径的方法

沙盒主目录

```
// 获取沙盒主目录路径
NSString *homeDir = NSHomeDirectory();
```

Documents目录

```
// 获取Documents目录路径
NSString *docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) firstObject];

// 存放文件
NSString *path = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES).firstObject;
    
NSString *fileName = [path stringByAppendingPathComponent:@"myfile"];

NSString *content = @"测试数据";

NSData *contentData = [content dataUsingEncoding:NSUTF8StringEncoding];

BOOL result = [contentData writeToFile:fileName atomically:YES];

//文件存放在Documents目录
```

Library目录

```

// 获取Library的目录路径
NSString *libDir = [NSSearchPathForDirectoriesInDomains(NSLibraryDirectory, NSUserDomainMask, YES) lastObject];

// 获取Caches目录路径
NSString *cachesDir = [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) firstObject];

// 缓存文件存放和Documents目录存放文件一样

//Preferences 通过 NSUserDefault存数据
```

tmp目录

```
// 获取tmp目录路径
NSString *tmpDir =  NSTemporaryDirectory();


// 缓存文件存放和Documents目录存放文件一样
```

AppBundle目录路径

```
// 获取AppBundle目录路径
NSLog(@"%@",[[NSBundle mainBundle] bundlePath]);

NSString *imagePath = [[NSBundle mainBundle] pathForResource:@"apple" ofType:@"png"];

UIImage *appleImage = [[UIImage alloc] initWithContentsOfFile:imagePath];
```





如何给App瘦身



https://github.com/Damonvvong/DevNotes/blob/master/Notes/optimize_app_size_1.md



sqllet

"FMDB使用说明书"

