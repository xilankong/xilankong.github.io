---
layout: post
category: iOS性能优化
title : "iOS底层实现逻辑"
---



### 一、AutoreleasePool  和 AutoreleasePoolPage

我们都知道  AutoreleasePool 是通过 AutoreleasePoolPage双向链表实现的，那具体的实现逻辑和自动释放时机是什么时候呢？

#### 1、AutoreleasePool

AutoreleasePool并没有单独的结构，而是由若干个AutoreleasePoolPage作为结点以双向链表的形式组合而成。

Runtime源码，整个链表以堆栈的形式运作。

```c
void * objc_autoreleasePoolPush(void) {
		return AutoreleasePoolPage::push();
}

void * objc_autoreleasePoolPop(void *ctxt) {
		return AutoreleasePoolPage::pop(ctxt);
}

1、每一个指针代表一个加入到释放池的对象 或者是哨兵对象，哨兵对象是在 @autoreleasepool{} 构建的时候插入的

2、当自动释放池 pop的时候，所有哨兵对象之后的对象都会release

3、链表会在一个Page空间占满时进行增加，一个AutoreleasePoolPage的空间被占满时，会新建一个AutoreleasePoolPage对象，连接链表，后来的autorelease对象在新的page加入。
```

#### 2、AutoreleasePoolPage

结构

```
class AutoreleasePoolPage
{
		magic_t const magic;
		id *next;
		pthread_t const thread;
		AutoreleasePoolPage * const parent;
		AutoreleasePoolPage *child;
		uint32_t const depth;
		uint32_t hiwat
}
```

1、id *next 指向了下一个能存放autorelease对象地址的区域

2、parent 父节点 指向前一个page

3、child 子节点 指向下一个page

![](https://xilankong.github.io/resource/autoreleasepoolpage.jpg)















