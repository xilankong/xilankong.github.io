<!-- ---
layout: post
category: iOS学习总结
title : "三方库原理分析"
--- -->


SDWebImageView  动图处理


https://www.jianshu.com/p/49ba11db96c6


1、解码

SDImageCoder
工厂模式的coder SDImageCoder 协议


2、动图播放原理

SDAnimatedImagePlayer

- SDDisplayLink + SDWeakProxy 刷新动画  
- displayLayer 一帧一帧刷在imageView的layer上 （同时预加载下一帧）


3、图片下载

SDWebImageDownloader单例对象

- 每个请求创建SDWebImageDownloadToken管理下载实例
- SDWebImageDownloader保存每个下载任务方便取消
- SDWebImageDownloadToken包含SWDweImageDownloaderOperation用于实际下载逻辑
- SDWebImageDownloaderOperationToken 管理单个下载，包括取消


NSOperation 队列

SDWebImageDownloaderOperation子类，SDWebImageDownloaderOperation协议<NSURLSessionTaskDelegate, NSURLSessionDataDelegate>

SDWebImageDownloaderOperation 下面还有 SDWebImageDownloaderOperationToken  可以操作取消


NSURLCache

- 优势

 - 支持内存、硬盘上的缓存，无需管理缓存，只需设置缓存上限  会自动清理

- 劣势

 - 可自定义空间小，使用的都是NSData，每次都需要重新转换



4、SDImageCache  两级缓存

- 1、SDMemoryCache 

本身继承自NSCache，会跟进系统内存紧张程度自行释放部分缓存

本身内部又开了一个弱缓存，NSMapTable

我的理解是为了提高缓存命中率，当系统内存紧张的时候NSCache自动在释放，
可能释放了当前在用的某些图片资源，这个时候如果这部分资源再次搜索缓存可能就会找不到，需要读磁盘，这个时候弱缓存可以命中,命中后再往NSCache中塞一份


通过重写setObject来实现 弱缓存的处理

最新版本用的不是自旋锁 是不公平锁（互斥锁）

#define SD_LOCK_DECLARE(lock) os_unfair_lock lock 


- 2、diskCache

IO 操作队列  是一个串行队列 

_ioQueue = dispatch_queue_create("com.hackemist.SDImageCache.ioQueue", DISPATCH_QUEUE_SERIAL)

- 图片类型分解，encode成NSData，串行队列异步写入diskcache
- 检查图片是否有sd_extendedObject，如果有则也会存储到硬盘中，使用了NSKeyedArchiver将sd_extendedObject转换为NSData，同上 一并写入diskcach
- 


SDImageCacheToken  处理diskCache查找操作，可以按key cancle


上采样 放大图，下采样  缩小图

downsampleImage 下采样  原理就是把 S * S区域内的图像变成一个像素点


https://www.jianshu.com/p/f15ad28ce3d1



AFnetworking


crash防护库


