---
0layout: post
category: iOS学习总结
title : "三方库原理分析"
---


SDWebImageView  动图处理


https://www.jianshu.com/p/49ba11db96c6

1、播放原理

SDAnimatedImagePlayer





2、SDImageCache  两级缓存

1、SDMemoryCache 

本身继承自NSCache，会跟进系统内存紧张程度自行释放部分缓存

本身内部又开了一个弱缓存，NSMapTable

我的理解是为了提高缓存命中率，当系统内存紧张的时候NSCache自动在释放，
可能释放了当前在用的某些图片资源，这个时候如果这部分资源再次搜索缓存可能就会找不到，需要读磁盘，这个时候弱缓存可以命中,命中后再往NSCache中塞一份


通过重写setObject来实现 弱缓存的处理

最新版本用的不是自旋锁 是不公平锁（互斥锁）

#define SD_LOCK_DECLARE(lock) os_unfair_lock lock 




2、diskCache

IO 操作队列  是一个串行队列 

_ioQueue = dispatch_queue_create("com.hackemist.SDImageCache.ioQueue", DISPATCH_QUEUE_SERIAL)

- 图片类型分解，encode成NSData，串行队列异步写入diskcache
- 检查图片是否有sd_extendedObject，如果有则也会存储到硬盘中，使用了NSKeyedArchiver将sd_extendedObject转换为NSData，同上 一并写入diskcach
- 
