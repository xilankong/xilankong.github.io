---
layout: post
category: 学习之路
title : "网络基础知识整理"
---



## 1、TCP-UDP

### 网络通信三要素

```
通过 “IP” 找服务器，通过 “端口” 找进程， 通过 “协议” 确定如何传输数据


IP地址(主机名)

端口号

用于标示进程的逻辑地址，不同进程的标示
有效端口：0~65535
其中 0~1024由系统使用或者保留端口
开发中不要使用 1024 以下的端口
注意 : 跟HTTP相关的端口一定是80.服务器上有个进程是专门处理HTTP请求的,端口号是80.

传输协议

TCP(传输控制协议) 
相当于打电话,必须先建立好链接才能传输数据. 
HTTP协议底层是基于TCP/IP协议的.
UDP(数据报文协议) 
相当于发电报,不用关心对方是否能够收到.不太安全.

HTTP网络传输协议在传输层选择的是TCP/IP协议
```



### UDP（User Datagram Protocol:用户数据报协议）

- 只管发送，不确认对方是否接收到
- 将数据源和目的封装成数据包中，不需要建立连接,是不可靠协议
- 每个数据报的大小限制在64K之内，速度快
- 应用场景：多媒体教室／网络流媒体 / 视频实时共享

### TCP（Transmission Control Protocol:传输控制协议）

- 建立连接，形成传输数据的通道
- 在连接中进行大数据传输（数据大小不受限制）
- 通过三次握手完成连接，四次分手结束连接,是可靠协议，安全送达
- 必须建立连接，效率会稍低,TCP协议的传输速度比UDP协议慢
- 提供超时重发，丢弃重复数据，检验数据，流量控制等功能



### TCP三次握手建立连接

- 要想明白Socket连接，先要明白TCP连接。手机能够使用联网功能是因为手机底层实现了TCP/IP协议，可以使手机终端通过无线网络建立TCP连接。
- 当应用层向TCP层发送用于网间传输的、用8位字节表示的数据流，TCP则把数据流分割成适当长度的报文段，最大传输段大小（MSS）通常受该计算机连接的网络的数据链路层的最大传送单元（MTU）限制。之后TCP把数据包传给IP层，由它来通过网络将包传送给接收端实体的TCP层。
- TCP为了保证报文传输的可靠，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已成功收到的字节发回一个相应的确认(ACK)；如果发送端实体在合理的往返时延(RTT)内未收到确认，那么对应的数据（假设丢失了）将会被重传。
- ACK表示Acknowledgment Number字段有意义 
  PSH表示Push功能，RST表示复位TCP连接 
  SYN表示SYN报文（在建立TCP连接的时候使用,发起一个新连接） 
  FIN表示没有数据需要发送了（在关闭TCP连接的时候使用）

TCP是主机对主机层的传输控制协议，提供可靠的连接服务，采用三次握手确认建立一个连接:

位码即tcp标志位,有6种标示:

SYN(synchronous建立联机)

ACK(acknowledgement 确认)

PSH(push传送)

FIN(finish结束)

RST(reset重置)

URG(urgent紧急)

Sequence number(顺序号码)

Acknowledge number(确认号码)



各个状态的意义如下：

  
LISTEN - 侦听来自远方TCP端口的连接请求；  
SYN-SENT -在发送连接请求后等待匹配的连接请求；  
SYN-RECEIVED - 在收到和发送一个连接请求后等待对连接请求的确认；  
ESTABLISHED- 代表一个打开的连接，数据可以传送给用户；  
FIN-WAIT-1 - 等待远程TCP的连接中断请求，或先前的连接中断请求的确认； 
FIN-WAIT-2 - 从远程TCP等待连接中断请求；  
CLOSE-WAIT - 等待从本地用户发来的连接中断请求；  
CLOSING -等待远程TCP对连接中断的确认；  
LAST-ACK - 等待原来发向远程TCP的连接中断请求的确认；  
TIME-WAIT -等待足够的时间以确保远程TCP接收到连接中断请求的确认；  
CLOSED - 没有任何连接状态；



第一次握手：建立连接时，客户端发送SYN包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认； 

第二次握手：服务器收到SYN包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进 入SYN_RECV状态； 

第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入 连接状态，完成三次握手，客户端与服务器开始传送数据.

```
握手过程中传送的包里”不包含数据 “，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP连接都将被一直保持下去。
```



![png](https://xilankong.github.io/resource/tcp.png)



如上：

### TCP四次挥手断开连接

由于 TCP 连接是全双工的，因此每个方向都必须单独进行关闭。这个原则是当一方完成它的数据发送任务后就能发送一个FIN 来终止这个方向的发送通道。收到一个 FIN 只意味着这一方向上没有数据流动，一个 TCP 连接在收到一个 FIN 后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。 

（ 1 ）客户端 A 发送一个 FIN ，用来关闭客户 A 到服务器 B 的数据传送。 
（ 2 ）服务器 B 收到这个 FIN ，它返回一个 ACK ，确认序号为收到的序号加 1 。和 SYN 一样，一个FIN 将占用一个序号。 
（ 3 ）服务器 B 关闭与客户端 A 的连接，发送一个 FIN 给客户端 A 。 
（ 4 ）客户端 A 发回 ACK 报文确认，并将确认序号设置为收到序号加 1 ,客服端关闭与服务器的连接。



### 拓展

1. 为什么TCP建立连接协议是三次握手，而关闭连接却是四次握手呢？ 
   - 这是因为服务端的LISTEN状态下的SOCKET当收到SYN报文的建连请求后，它可以把ACK和SYN（ACK起应答作用，而SYN起同步作用）放在一 个报文里来发送。
   - 但关闭连接时，当收到对方的FIN报文通知时，它仅仅表示对方没有数据发送给你了；但未必你所有的数据都全部发送给对方了，所以你可以未 必会马上会关闭SOCKET,也即你可能还需要发送一些数据给对方之后，再发送FIN报文给对方来表示你同意现在可以关闭连接了，所以它这里的ACK报文 和FIN报文多数情况下都是分开发送的。 
2. 为什么TIME_WAIT状态还需要等2MSL后才能返回到CLOSED状态？  
   因为虽然双方都同意关闭连接了，而且握手的4个报文也都发送完毕，按理可以直接回到CLOSED 状态(就好比从SYN_SENT 状态到ESTABLISH 状态那样)，但是我们必须假想网络是不可靠的，你无法保证你(客户端)最后发送的ACK报文一定会被对方收到，就是说对方处于LAST_ACK 状态下的SOCKET可能会因为超时未收到ACK报文，而重发FIN报文，所以这个TIME_WAIT 状态的作用就是用来重发可能丢失的ACK报文。
3. 关闭TCP连接一定需要4次挥手吗?
   - 不一定，4次挥手关闭TCP连接是最安全的做法。但在有些时候，我们不喜欢TIME_WAIT 状态(如当MSL数值设置过大导致服务器端有太多TIME_WAIT状态的TCP连接，减少这些条目数可以更快地关闭连接，为新连接释放更多资源)
   - 我们可以通过设置SOCKET变量的SO_LINGER标志来避免SOCKET在close()之后进入TIME_WAIT状态，这时将通过发送RST强制终止TCP连接(取代正常的TCP四次握手的终止方式)。但这并不是一个很好的主意，TIME_WAIT 对于我们来说往往是有利的



## 2、RTMP 推流



推流，就是将采集到的音频，视频数据通过流媒体协议发送到流媒体服务器。

https://www.jianshu.com/p/66275a44eb83



