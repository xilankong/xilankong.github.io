---
layout: post
category: 2017å¹´
title : "fastlaneä½¿ç”¨è¯´æ˜ä¹¦"
---

## fastlane ä»‹ç»

fastlaneæ˜¯ç”¨Rubyè¯­è¨€ç¼–å†™çš„ä¸€å¥—è‡ªåŠ¨åŒ–å·¥å…·é›†å’Œæ¡†æ¶ï¼Œæ¯ä¸€ä¸ªå·¥å…·å®é™…éƒ½å¯¹åº”ä¸€ä¸ªRubyè„šæœ¬ï¼Œç”¨æ¥æ‰§è¡ŒæŸä¸€ä¸ªç‰¹å®šçš„ä»»åŠ¡ï¼Œè€ŒFastlaneæ ¸å¿ƒæ¡†æ¶åˆ™å…è®¸ä½¿ç”¨è€…é€šè¿‡ç±»ä¼¼é…ç½®æ–‡ä»¶çš„å½¢å¼ï¼Œå°†ä¸åŒçš„å·¥å…·æœ‰æœºè€Œçµæ´»çš„ç»“åˆåœ¨ä¸€èµ·ï¼Œä»è€Œå½¢æˆä¸€ä¸ªä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚æ¯”å¦‚æˆ‘éœ€è¦å®Œæˆä¸€å¥—å‘å¸ƒæµç¨‹ï¼š

```
#å‘å¸ƒåˆ°AppStore

lane :release do
  #å¢åŠ buildç‰ˆæœ¬å·,éœ€è¦å…ˆé…ç½®build setting
  increment_build_number
  #podèµ„æºæ›´æ–°
  cocoapods
  #æ‰“åŒ…
  gym
  #å‘å¸ƒåˆ°AppStore
  deliver(force: true)
  #å‘å¸ƒtestflightæµ‹è¯•
  pilot
end
```



#### ä¾èµ–ç¯å¢ƒï¼š

- Xcode7 +
- macOS or Linux with Ruby 2.0.0 +



#### æœ¬æ–‡ç‰ˆæœ¬ï¼š

fastlaneç‰ˆæœ¬ï¼š2.53.1

2017/10 æ›´æ–° : 2.62.1

#### æ–‡æ¡£åœ°å€ï¼š

[Doc](https://docs.fastlane.tools)

#### å®‰è£…ï¼š

[sudo] gem install fastlane

```
å¦‚æœç”¨çš„æ˜¯macè‡ªå¸¦çš„rubyï¼Œéœ€è¦ sudoæƒé™
ä½¿ç”¨: sudo gem install fastlane

å¦‚æœæŠ¥é”™ï¼šERROR: While executing gem ... (Errno::EPERM) Operation not permitted - /usr/bin/commander 
ä½¿ç”¨: sudo gem install -n /usr/local/bin fastlane
```



#### åˆå§‹åŒ–ï¼š

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œåˆå§‹åŒ–Fastlaneï¼š

```
fastlane init
```

fastlane ä¼šè¦æ±‚å¡«å†™ä½ çš„Apple IDï¼Œé€‰æ‹©ä½ çš„Team(å¦‚æœæœ‰å¤šä¸ª) ç„¶åfastlaneä¼šè‡ªåŠ¨æ£€æµ‹å½“å‰ç›®å½•ä¸‹é¡¹ç›®çš„App Nameå’ŒApp Identifierã€Projectã€‚ç„¶åè‡ªè¡Œç¡®è®¤å¹¶æŒ‰æµç¨‹æ‰§è¡Œã€‚

fastlane åˆå§‹åŒ–é»˜è®¤ä¼šåˆ›å»ºä¸‰ä¸ªæ–‡ä»¶ï¼šFastfileã€Appfileã€Deliverfileï¼›ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼šmetadataã€screenshots

Fastfile : æ ¸å¿ƒæ–‡ä»¶ï¼Œä¸»è¦ç”¨äº cli è°ƒç”¨å’Œå¤„ç†å…·ä½“çš„æµç¨‹ï¼Œlaneç›¸å¯¹äºä¸€ä¸ªæ–¹æ³•æˆ–è€…å‡½æ•°

Appfile : å­˜å‚¨æœ‰å…³å¼€å‘è€…è´¦å·ç›¸å…³ä¿¡æ¯

Deliverfile: deliverå·¥å…·çš„é…ç½®æ–‡ä»¶



#### å¸¸ç”¨å‘½ä»¤ï¼š

- fastlane actions: å±•ç¤ºæ‰€æœ‰æœ‰æ•ˆactionåˆ—è¡¨
- fastlane action [action_name]: å±•ç¤ºä¸€ä¸ªactionçš„è¯¦ç»†è¯´æ˜ï¼Œä½¿ç”¨æ–¹æ³•ç­‰
- fastlane lanes: å±•ç¤ºfastfileä¸­çš„æ‰€æœ‰lane
- fastlane list: å±•ç¤ºfastfileä¸­çš„æ‰€æœ‰çš„æœ‰æ•ˆçš„lane
- fastlane new_action: åˆ›å»ºä¸€ä¸ªæ–°çš„action
- fastlane env: æ‰“å°fastlaneã€rubyç¯å¢ƒï¼Œä¸€èˆ¬æbugåˆ°issueçš„æ—¶å€™ä¼šè¦æ±‚æä¾›



#### ç”Ÿå‘½å‘¨æœŸï¼š

| æ‰§è¡Œé¡ºåº | æ–¹æ³•å         | è¯´æ˜                     |
| ---- | ----------- | ---------------------- |
| 1    | before_all  | åœ¨æ‰§è¡Œ lane ä¹‹å‰åªæ‰§è¡Œä¸€æ¬¡       |
| 2    | before_each | æ¯æ¬¡æ‰§è¡Œ lane ä¹‹å‰éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡     |
| 3    | lane        | è‡ªå®šä¹‰çš„ä»»åŠ¡                 |
| 4    | after_each  | æ¯æ¬¡æ‰§è¡Œ lane ä¹‹åéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡     |
| 5    | after_all   | åœ¨æ‰§è¡Œ lane æˆåŠŸç»“æŸä¹‹åæ‰§è¡Œä¸€æ¬¡    |
| 6    | error       | åœ¨æ‰§è¡Œä¸Šè¿°æƒ…å†µä»»æ„ç¯å¢ƒæŠ¥é”™éƒ½ä¼šä¸­æ­¢å¹¶æ‰§è¡Œä¸€æ¬¡ |



#### å…¶ä»–ï¼š

1.å¦‚æœDeliverfileã€screenshotså’Œmetadataæ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆï¼Œé€šè¿‡deliver init å¯ä»¥é‡æ–°åˆå§‹åŒ–

2.fastlaneçš„é…ç½®ä¼šè¦æ±‚è¾“å…¥å¼€å‘è€…è´¦å·å¯†ç ï¼Œæ‰€æœ‰çš„å¯†ç éƒ½åŠ å¯†ä¿å­˜åœ¨ç³»ç»Ÿçš„Keychainé‡Œ

3.Matchfile: match è¿™ä¸ªactionçš„é…ç½®æ–‡ä»¶ï¼Œfastlane match init è‡ªåŠ¨ç”Ÿæˆï¼Œå­˜æ”¾gitåœ°å€ç­‰

4.iOS11å‡çº§ä»¥åå‡ºç°ä¸€ä¸ªä¸¤æ­¥éªŒè¯çš„é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œæˆ–è€…ä¼šè¯è¿‡æœŸéƒ½ä¼šå‡ºç°ã€‚ä¹‹å‰æ˜¯åªéœ€è¦è¾“å…¥æ‰‹æœºå¼¹å‡ºçš„4ä½éªŒè¯ç ï¼Œç°åœ¨è¦æ±‚ç‚¹å‡»å…è®¸å¹¶è¾“å…¥éªŒè¯ç ã€‚ä¸‹é¢æ˜¯æ­£å¸¸å…è®¸å¹¶è¾“å…¥éªŒè¯ç åçš„æç¤ºã€‚(åé¢è¿˜ä¼šè§£é‡Šè¿™ä¸ªé—®é¢˜)

```
Two Factor Authentication for account 'xxxx.com' is enabled
Your session cookie has been expired.
Please enter the 6 digit code: 00000
```

5.è¿˜æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µä¹Ÿè®¸å¹¶æ²¡æœ‰ç¢°åˆ°ï¼Œéœ€è¦è‡ªè¡Œå‘æ˜



## fastlane ä½¿ç”¨

### laneçš„ä½¿ç”¨

laneæ˜¯fastfileä¸­çš„æ–¹æ³•å®šä¹‰æ ‡ç­¾ï¼Œå¯ä»¥ç†è§£ä¸ºswiftä¸­å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå‰é¢çš„ funcã€‚fastlane éƒ½æ˜¯åŸºäºrubyï¼Œæ‰€ä»¥fastfileä¸­ä¹Ÿæ˜¯ä½¿ç”¨rubyè¯­æ³•çš„ã€‚

å®šä¹‰ä¸€ä¸ªç®€å•çš„æ— å‚lane

```
lane :package
	puts "è¿™æ˜¯ä¸€ä¸ªlane"
end
```

å®šä¹‰ä¸€ä¸ªå¸¦å‚çš„laneï¼Œåœ¨fastfileä¸­optionç±»ä¼¼äºä¸€ä¸ªå­—å…¸é›†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡  option[:configuration] å–å…¶ä¸­value

```
 lane :package do |option| 
    configuration = option[:configuration]
    puts configuration
 end
 
 //laneçš„è°ƒç”¨
 package(configuration: 'Release', export_method: 'ad-hoc')
```



### Action

é™¤å¼€æˆ‘ä»¬è‡ªå®šä¹‰fastfileä¸­çš„æ–¹æ³•ï¼Œfastlaneè¿˜æä¾›äº†å¾ˆå¤šå·²ç»å†™å¥½çš„ç‹¬ç«‹çš„æ–¹æ³•åº“ï¼Œä¹Ÿå°±æ˜¯Actionsã€‚

Actionæ˜¯Fastlaneè‡ªåŠ¨åŒ–æµç¨‹ä¸­çš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œç›´è§‚ä¸Šæ¥è®²å°±æ˜¯Fastfileè„šæœ¬ä¸­çš„ä¸€ä¸ªä¸ªå‘½ä»¤ï¼Œè€Œè¿™äº›å‘½ä»¤èƒŒåéƒ½å¯¹åº”ä¸€ä¸ªç”¨Rubyç¼–å†™çš„è„šæœ¬ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒFastlaneçš„å·¥å…·é›†å¤§çº¦åŒ…å«180å¤šä¸ªActionï¼ŒåŸºæœ¬ä¸Šæ¶µç›–äº†æ‰“åŒ…ï¼Œç­¾åï¼Œæµ‹è¯•ï¼Œéƒ¨ç½²ï¼Œå‘å¸ƒï¼Œåº“ç®¡ç†ç­‰ç­‰ç§»åŠ¨å¼€å‘ä¸­æ¶‰åŠåˆ°çš„å†…å®¹ã€‚

```
fastlane actions : æŸ¥çœ‹actionåˆ—è¡¨

fastlane action  action_nameï¼šæŸ¥çœ‹å…·ä½“action æè¿°
```

#### å¸¸ç”¨Action

Actionåˆ—è¡¨æ–‡æ¡£: [Actions](https://docs.fastlane.tools/actions/)

æˆ‘ä»¬å¸¸ç”¨çš„ä¸»è¦åŒ…æ‹¬ä¸‹é¢å‡ éƒ¨åˆ†ï¼Œå…¶ä»–actionçš„ä½¿ç”¨å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£:

- [scan](https://github.com/fastlane/fastlane/tree/master/scan) => è‡ªåŠ¨è¿è¡Œæµ‹è¯•å·¥å…·ï¼Œå¹¶ä¸”å¯ä»¥ç”Ÿæˆæ¼‚äº®çš„HTMLæŠ¥å‘Š
- [match](https://github.com/fastlane/fastlane/tree/master/match) => ä¸€ä¸ªæ–°çš„è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ç®¡ç†å·¥å…·ã€‚æŠŠæ‰€æœ‰éœ€è¦ç”¨åˆ°çš„è¯ä¹¦ä¼ åˆ°gitç§æœ‰åº“ä¸Šï¼Œä»»ä½•éœ€è¦é…ç½®çš„æœºå™¨ç›´æ¥ç”¨matchåŒæ­¥å›æ¥å°±ä¸ç”¨ç®¡è¯ä¹¦é—®é¢˜äº†
- [gym](https://github.com/fastlane/fastlane/tree/master/gym) => Fastlaneå®¶æ—çš„è‡ªåŠ¨åŒ–ç¼–è¯‘å·¥å…·ï¼Œå’Œå…¶ä»–å·¥å…·é…åˆçš„éå¸¸é»˜å¥‘
- [deliver](https://github.com/fastlane/fastlane/tree/master/deliver) => è‡ªåŠ¨ä¸Šä¼ æˆªå›¾ï¼ŒAPPçš„å…ƒæ•°æ®ï¼ŒäºŒè¿›åˆ¶(ipa)æ–‡ä»¶åˆ°iTunes Connect
- [pilot](https://github.com/fastlane/fastlane/tree/master/pilot) => ç®¡ç†TestFlightçš„æµ‹è¯•ç”¨æˆ·ï¼Œä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶
- [spaceship](https://github.com/fastlane/fastlane/tree/master/spaceship) => ä¸ºpilotï¼Œboardingå’Œdeliverç­‰å·¥å…·æä¾›å’Œ iTC å’Œ ADC çš„äº¤äº’APIã€‚spaceshipæœ¬æ¥æ˜¯ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œåæ¥è¢«Fastlaneæ”¶ç¼–è¿›æ¥ [éå®˜æ–¹çš„iTunes Connect JSON APIçš„æ–‡æ¡£](https://github.com/fastlane/itc-api-docs)  

#### å¸¸ç”¨Actionä½¿ç”¨

scan

```
releaseæƒ…å†µä¸‹æ— æ³•æ­£å¸¸è¿è¡Œscanï¼Œéœ€è¦æ‰‹åŠ¨å»Build Settingä¸­æ›´æ”¹enable Testability åœ¨release ä¸‹çš„çŠ¶æ€ï¼Œæ”¹ä¸º yesæ‰å¯ä»¥è¿è¡Œã€‚ä½†æ˜¯å®˜æ–¹ä¸å»ºè®®åšreleaseä¸‹å¼€å¯ï¼ŒTestä¸€èˆ¬åœ¨development configuration ä¸‹æ‰§è¡Œã€‚
```

match

```
ä¸€ä¸ªæ–°çš„è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ç®¡ç†å·¥å…·ã€‚å®ƒä¼šæŠŠæ‰€æœ‰éœ€è¦ç”¨åˆ°çš„è¯ä¹¦ä¼ åˆ°gitç§æœ‰åº“ä¸Šï¼Œä»»ä½•éœ€è¦é…ç½®çš„æœºå™¨ç›´æ¥ç”¨matchåŒæ­¥å›æ¥å°±ä¸ç”¨ç®¡è¯ä¹¦é—®é¢˜äº†ã€‚ä¿è¯å¤§å®¶ç”¨çš„éƒ½æ˜¯åŒä¸€ä»½ã€‚ä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä¸€å°æœºå™¨éœ€è¦ç”¨åˆ°distributionè¯ä¹¦ï¼Œæ‰€ä»¥æ„ä¹‰ä¸å¤§ã€‚

1.matchåªè®¤è¯†é€šè¿‡matchæ–¹å¼åˆ›å»ºçš„ppæ–‡ä»¶ è¯ä¹¦ï¼Œå…¶ä»–æ–¹å¼åˆ›å»ºçš„ä¸äºˆç†ä¼šã€‚
2.ä½¿ç”¨match éœ€è¦å…ˆæ’¤é”€ç°åœ¨çš„è¯ä¹¦ã€‚
3.å¦‚æœè‹¹æœç«¯çš„è¯ä¹¦,ppæ–‡ä»¶å·²åˆ é™¤ï¼Œé‚£ä¹ˆè¿œç«¯gitä¸Šçš„æ–‡ä»¶ä¹Ÿä¼šå¤±æ•ˆï¼Œå¹¶ä¸”åœ¨é‡æ–°matchçš„æ—¶å€™ä¼šå¤±è´¥,å¥½åƒå°±åªèƒ½åˆ å…‰ gitç«¯å†…å®¹ï¼Œé‡æ–°matchä¸€éã€‚

å¸¸ç”¨å‚æ•°ï¼š
git_url ï¼š æŒ‡å®šå¯¹åº”gitåœ°å€
git_branch ï¼š æŒ‡å®šå¯¹åº”branch
type ï¼šè¯·æ±‚æ–‡ä»¶ç±»å‹, appstore, adhoc, development, enterprise
app_identifier ï¼š app_bundle_identify
clone_branch_directly : åªæ›´æ–°å¯¹åº”branchï¼Œåªæœ‰åœ¨å­˜åœ¨è¿™ä¸ªbranchæ—¶æ‰ç”Ÿæ•ˆ
force_for_new_devices : å¦‚æœè®¾å¤‡devicesåˆ—è¡¨æ›´æ–°äº†ï¼Œå°±å¼ºåˆ¶æ›´æ–°é…ç½®æ¦‚è¦æ–‡ä»¶
verbose ï¼šæ‰“å°å‡ºé¢å¤–çš„ä¿¡æ¯å’Œæ‰€æœ‰çš„å‘½ä»¤
```

gym

```
å¸¸ç”¨å‚æ•°ï¼š
scheme ï¼šæŒ‡å®šæ‰“çš„å“ªä¸ªscheme
project ï¼šæŒ‡å®šproject (æœªä½¿ç”¨cocopods)
workspace ï¼šæŒ‡å®šworkspace (ä½¿ç”¨cocopods)
clean ï¼šæ‰“åŒ…å‰clean
xcargs ï¼š é™„åŠ ä¸€äº›å‚æ•°ä¼ é€’ç»™xcodebuild å¦‚ï¼š xcargs: 'DEBUG_INFORMATION_FORMAT="dwarf-with-dsym"',
export_method ï¼šå‡ºåŒ…æ–¹æ³• app-store, ad-hoc, package, enterprise, development
configuration ï¼š æŒ‡å®šæ„å»ºAppçš„é…ç½®  Releaseã€Debugã€è‡ªå®šä¹‰
output_directory ï¼š è¾“å‡ºç›®å½•
output_name ï¼šè¾“å‡ºåç§°
include_symbols ï¼šæ˜¯å¦åŒ…å«è°ƒè¯•ç¬¦å·
include_bitcode ï¼šæ˜¯å¦å¼€å¯bitcode

çº¯swiftå·¥ç¨‹æ‰“åŒ…ï¼Œåœ¨éappstoreè¯ä¹¦ä¸‹ç­¾å‡ºæ¥çš„åŒ…éƒ½ç¼ºå°‘ä¸€ä¸ªswiftsupportæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ”¾çš„æ˜¯swiftçš„æ”¯æŒåº“ã€‚
```

deliver

```
ç”¨äºç›´æ¥å‘åŒ…åˆ°appstoreï¼Œæš‚æ—¶æœªä½¿ç”¨ï¼Œåç»­è¡¥ä¸Š
```

pilot

```
ç”¨äºå‘å¸ƒtestflightå†…éƒ¨æµ‹è¯•ï¼Œå±äºtestflight actionçš„åˆ«å

å¸¸ç”¨å‚æ•°:
ipa ï¼šè¦æäº¤çš„åŒ…åœ°å€
team_nameã€team_id ï¼šå¦‚æœæœ‰å¤šä¸ªteam ç”¨äºåŒºåˆ†team
skip_waiting_for_build_processing ï¼š åœ¨æäº¤å®Œæˆåçš„ç­‰å¾…æ˜¯å¦è·³è¿‡ï¼Œä¸€èˆ¬è·³è¿‡

testflight(
  ipa : '../xx.ipa'
)
```

spaceship

```
spaceshipå…¶å®ä¸€èˆ¬fastfileä¸­ä¸ä¼šä½¿ç”¨åˆ°ï¼Œä½†æ˜¯ç”±äºæ¶‰åŠåˆ°ä¸ADCçš„é€šä¿¡ï¼Œä¼šå‡ºç°ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œæ‰€ä»¥å¯¹å®ƒä¹Ÿè¦æœ‰ä¸€ç‚¹äº†è§£ã€‚

å½“æˆ‘ä»¬é€šè¿‡CI è¿›è¡ŒæŒç»­åŒ–çš„æ—¶å€™ï¼Œä¼šé‡åˆ°å¦‚ä¸‹é—®é¢˜ï¼š

Q1ï¼šé€šè¿‡CIå»æäº¤åŒ…åˆ°TestFlight/ITCçš„æ—¶å€™ï¼Œéœ€è¦ç”Ÿæˆä¸€ä¸ªç‰¹å®šäºåº”ç”¨ç¨‹åºçš„å¯†ç :

1.https://appleid.apple.com/account/manage
2.ç”Ÿæˆä¸€ä¸ª APP-SPECIFIC PASSWORDSï¼Œä¿ç•™ç”Ÿæˆçš„ç‰¹æ®Šå¯†ç 
3.ä½¿ç”¨ç¯å¢ƒå˜é‡æä¾›è¿™ä¸ªå¯†ç ç»™fastlaneï¼š  FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD

å½“ç„¶ï¼Œä½ å¯ä»¥åœ¨CIæŒ‡å‘çš„ç›®æ ‡æ‰“åŒ…æœºä¸­é¢„å…ˆè·‘èµ·æ¥ï¼Œå¹¶æ‰‹åŠ¨è¾“å…¥å¯†ç ï¼Œå¯†ç ä¼šè‡ªåŠ¨ä¿å­˜åœ¨keyChainä¸­ã€‚

Q2ï¼šå¦‚æœä½ çš„å¼€å‘è€…è´¦å·è®¾ç½®äº†ä¸¤æ­¥éªŒè¯æ€ä¹ˆåŠï¼Ÿ

1.å½“ç¬¬ä¸€æ¬¡ä½¿ç”¨fastlaneå®‰è£…çš„æ—¶å€™ï¼Œä¼šè¦æ±‚æä¾›ä¸¤æ­¥éªŒè¯æ ¸å®ä½ çš„èº«ä»½æ¥è¿æ¥ADCï¼Œè¿™ä¸ªæ—¶å€™ä¼šå°†ä¼šè¯å­˜åˆ° spaceship çš„ cookieï¼Œä¼šè¯å¤§æ¦‚ä¸€ä¸ªæœˆæœ‰æ•ˆæœŸï¼Œä½†è¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬è¦æ±‚çš„
2.é‚£é—®é¢˜æ¥äº†ï¼Œå¦‚æœé€šè¿‡CI çš„è¯ï¼Œæ€ä¹ˆå»å¤„ç†ä¸¤æ­¥éªŒè¯çš„é—®é¢˜ï¼Œè¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ
3.æˆ‘ä»¬å¯ä»¥é€šè¿‡fastlaneå»æŠŠè¿™ä»½cookieè½¬æˆç¯å¢ƒå˜é‡é…ç½®
4.fastlane spaceauth -u apple@krausefx.com  è·å–åˆ°ä¸€ä»½é…ç½®å†…å®¹,æŠŠè¿™ä»½å†…å®¹é…ç½®åœ¨CIä¸­ï¼Œæˆ–è€…fastfileä¸­ï¼Œå¦‚ä¸‹ï¼š
export FASTLANE_SESSION='---\n- !ruby/object:HTTP::Cookie\n  name: DES5c148586dfd451e55afbaaa5f62418f91\n  value: HSARMTKNSRVTWFla1+yO4gVPowH17VaaaxPFnUdMUegQZxqy1Ie1c2v6bM1vSOzIbuOmrl/FNenlScsd/NbF7/Lw4cpnL15jsyg0TOJwP32tC/NguPiyOaaaU+jrj4tf4uKdIywVaaaFSRVT\n  domain: idmsa.apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires: 2016-04-27 23:55:56.000000000 Z\n  max_age: \n  created_at: 2016-03-28 16:55:57.032086000 -07:00\n  accessed_at: 2016-03-28 19:11:17.828141000 -07:00\n'

fastfile ç¯å¢ƒå˜é‡åç§° FASTLANE_SESSION
```



ä¸Šé¢æåˆ°çš„è¿™äº›actionéƒ½æ˜¯å¸¸ç”¨çš„ï¼Œæ­£å¸¸æ‰“åŒ…æµç¨‹å¿…ä¸å¯å°‘çš„éƒ¨åˆ†ï¼Œè¿˜æœ‰ä¸€äº›å¸¸ç”¨äºè¾…åŠ©ä½œç”¨çš„Action

- resign  ï¼šé‡æ–°ç­¾å

  ```
  fastlane sigh resign dev.ipa --signing_identity "è¯ä¹¦ID" -p â€œdev.mobileprovision"
  ```

- get_info_plist_value  ï¼šè·å–info.plistä¸­å¾—æŸä¸ªkeyçš„å€¼

- set_info_plist_value  ï¼šè®¾ç½®info.plistä¸­å¾—æŸä¸ªkeyçš„å€¼

- increment_build_number  ï¼šè‡ªåŠ¨é€’å¢é¡¹ç›®buildå·

- increment_version_number  ï¼šè‡ªåŠ¨é€’å¢é¡¹ç›®ç‰ˆæœ¬å·

ä»¥ä¸Šä¸¤ä¸ªéƒ½éœ€è¦å…ˆé…ç½®å¥½xcode, [é…ç½®æ–‡æ¡£](https://developer.apple.com/library/content/qa/qa1827/_index.html)


### è‡ªå®šä¹‰Action

ç”±äºå¼€å‘éœ€æ±‚å„è‡ªä¸åŒï¼Œå·²æœ‰çš„actionä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼ŒFastlaneæ”¯æŒå®šä¹‰è‡ªå·±çš„Actionã€‚Fastlaneä¸ºæˆ‘ä»¬æä¾›äº†ç°æˆçš„æ¨¡æ¿ï¼Œå³ä½¿ä½ å¯¹Rubyçš„è¯­æ³•ä¸ç†Ÿæ‚‰ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼ŒFastlaneæ˜¯å¼€æºçš„å˜›ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½æºç çœ‹çœ‹åˆ«äººçš„Actionæ˜¯æ€ä¹ˆå†™çš„å°±çŸ¥é“äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªç›®å½•ä¸‹æ‰¾åˆ°æ‰€æœ‰çš„Actionæ–‡ä»¶ï¼š

[Action_rbs](https://github.com/fastlane/fastlane/tree/master/fastlane/lib/fastlane/actions)

å‡è®¾ï¼Œæˆ‘ä»¬é’ˆå¯¹podçš„æ‰§è¡Œåˆ›å»ºä¸€ä¸ªactionæ¥é’ˆå¯¹ä¸‹é¢ä¸‰ç§æƒ…å†µçš„æ‰§è¡Œ

```
pod install --no-repo-update (é¿å…master repoçš„æ¯æ¬¡æ›´æ–°è€—æ—¶)
pod update --no-repo-update (é¿å…master repoçš„æ¯æ¬¡æ›´æ–°è€—æ—¶)
pod repo update XXX (ç§æœ‰repoçš„æ›´æ–°)
```

è‡ªå®šä¹‰Actionçš„æµç¨‹å¤§çº¦å¦‚ä¸‹ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œå‘½ä»¤ï¼š

```
fastlane new_action
```

ç„¶åæ ¹æ®æç¤ºï¼Œåœ¨å‘½ä»¤è¡Œä¸­æ•²å…¥actionçš„åå­—podï¼Œç„¶åFastlaneä¼šåœ¨å½“å‰ç›®å½•çš„actionsæ–‡ä»¶å¤¹ä¸­å¸®æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªpod.rbçš„Rubyæ–‡ä»¶ ï¼ˆæ­¤å¤„åªæœ‰éƒ¨åˆ†ä»£ç ï¼‰

```
module Fastlane
  module Actions
    module SharedValues
      POD_CUSTOM_VALUE = :POD_CUSTOM_VALUE
    end
    class PodAction < Action
      def self.run(params)
        UI.message "Parameter API Token: #{params[:api_token]}"
      end
      ......
      def self.available_options
        # Define all options your action supports. 
      end
      ......
```

å¯ä»¥çœ‹åˆ°ï¼Œè‡ªå®šä¹‰çš„Actionéƒ½æ˜¯éš¶å±äºFastlane/Actionsè¿™ä¸ªmoduleï¼Œå¹¶ä¸”ç»§æ‰¿è‡ªActionè¿™ä¸ªçˆ¶ç±»ã€‚è™½ç„¶æ¨¡æ¿ä¸­çš„å†…å®¹è¿˜æŒºå¤šï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œå¤§éƒ¨åˆ†å†…å®¹éƒ½æ˜¯ä¸€äº›ç®€å•çš„æ–‡æœ¬æè¿°ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´åªéœ€è¦é‡ç‚¹å…³æ³¨è¿™ä¸¤ä¸ªæ–¹æ³•å°±è¡Œï¼š

1. self.runæ–¹æ³•ï¼šè¿™é‡Œæ”¾ç½®çš„æ˜¯å®é™…çš„ä¸šåŠ¡å¤„ç†ä»£ç ã€‚
2. self.available_optionsæ–¹æ³•ï¼šè¿™é‡Œå£°æ˜éœ€è¦å¯¹å¤–æš´éœ²å‡ºçš„å‚æ•°ï¼Œæ²¡æœ‰å£°æ˜çš„å‚æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ— æ³•ä½¿ç”¨ã€‚

æœ€ç»ˆå†™å®Œç»“æœå¦‚ä¸‹ï¼š

```
module Fastlane
  module Actions
    module SharedValues
      POD_INSTALL_CUSTOM_VALUE = :POD_INSTALL_CUSTOM_VALUE
    end
    class PodInstallAction < Action
      def self.run(params)
        repo = "-no-repo-update"
        command = []
        command << "pod install"
        if params[:repo_update]
          repo = "--repo-update"
        end
        command << repo
        if params[:verbose]
          command << "--verbose"
        end
        result = Actions.sh(command.join(' '))
        UI.success(command.join(' ') + " Successfully ")
        return result
      end

      def self.description
        "pod install action"
      end
      def self.details
        "verbose / repo-update"
      end
      def self.available_options
        [
        FastlaneCore::ConfigItem.new(key: :verbose,
                                       description: "Allow output detail in console",
                                       optional: true,
                                       is_string: false,
                                       default_value: false),
          FastlaneCore::ConfigItem.new(key: :repo_update,
                                       description: "Allow output detail in console",
                                       optional: true,
                                       is_string: false,
                                       default_value: false)
        ]
      end
      def self.output
      end
      def self.return_value
      end
      def self.authors
        ["yang"]
      end
      def self.is_supported?(platform)
        platform == :ios
      end
    end
  end
end
```

Actionå¼•ç”¨æœºåˆ¶

è¿œç¨‹å¼•ç”¨

```
# è¿œç¨‹Gitå¼•ç”¨ï¼š
import_from_git(url: 'https://github.com/xilankong/ruby', branch: 'master')
# å¤å†™å‘å¸ƒé¡¹ç›®çš„lane
lane :do_deliver_app do |options|
  # ...
end
```

æœ¬åœ°å¼•ç”¨

```
import "../GeneralFastfile"
actions_path '../custom_actions_folder/'
lane :appstore do |options|
  # ...
end
```



### Plugin

æˆ‘ä»¬åœ¨ä½¿ç”¨Fastlaneçš„æ—¶å€™å¸¸å¸¸ä¼šé‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼š

1. æˆ‘çš„è‡ªå®šä¹‰Actionéœ€è¦åœ¨å¤šä¸ªå†…éƒ¨é¡¹ç›®ä¸­ä½¿ç”¨
2. æˆ‘è§‰å¾—è¿™ä¸ªè‡ªå®šä¹‰Actionå¾ˆä¸é”™ï¼Œæƒ³å…±äº«ç»™å…¶ä»–çš„å›¢é˜Ÿä½¿ç”¨

æ­¤æ—¶ï¼Œæ‹·è´ç²˜è´´è™½ç„¶å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†å¹¶ä¸æ˜¯ä¸€ä¸ªèªæ˜çš„æ–¹æ¡ˆã€‚å°†Actionå‘å¸ƒåˆ°Fastlaneçš„å®˜æ–¹ä»“åº“å€’æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯å®˜æ–¹ä»“åº“æœ¬èº«å¯¹Actionçš„è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶ä¸ä¼šæ¥æ”¶éé€šç”¨æ€§çš„Actionï¼Œå³ä½¿æ¥æ”¶äº†ï¼Œæ•´ä¸ªå‘å¸ƒå‘¨æœŸä¹Ÿä¼šæ¯”è¾ƒé•¿ï¼Œè€Œä¸”ä»¥åæ— è®ºæ˜¯å‡çº§è¿˜æ˜¯Bugä¿®å¤ï¼Œéƒ½ä¾èµ–Fastlaneæœ¬èº«çš„å‘ç‰ˆï¼Œå¤§å¤§é™ä½äº†çµæ´»æ€§ã€‚

æ‰€ä»¥ä»1.93å¼€å§‹ï¼ŒFastlaneæä¾›äº†ä¸€ç§Pluginçš„æœºåˆ¶æ¥è§£å†³è¿™ç§é—®é¢˜ã€‚å¤§å®¶å¯ä»¥ç†è§£ä¸ºï¼šPluginå°±æ˜¯åœ¨Actionçš„åŸºç¡€ä¸Šåšäº†ä¸€å±‚åŒ…è£…ï¼Œè¿™ä¸ªåŒ…è£…å·§å¦™çš„åˆ©ç”¨äº†RubyGemsè¿™ä¸ªç›¸å½“æˆç†Ÿçš„Rubyåº“ç®¡ç†ç³»ç»Ÿï¼Œæ‰€ä»¥å…¶å¯ä»¥ç‹¬ç«‹äºFastlaneä¸»ä»“åº“è¿›è¡ŒæŸ¥æ‰¾ï¼Œå®‰è£…ï¼Œå‘å¸ƒå’Œåˆ é™¤ã€‚

æˆ‘ä»¬ç”šè‡³å¯ä»¥ç®€å•çš„è®¤ä¸ºï¼šPluginå°±æ˜¯RubyGemå°è£…çš„Actionï¼Œæˆ‘ä»¬å¯ä»¥åƒç®¡ç†RubyGemsä¸€æ ·æ¥ç®¡ç†Fastlaneçš„Pluginã€‚

ä½†æ˜¯ï¼Œå¦‚æœä¸ºäº†å¤šé¡¹ç›®å…±äº«ä»»åŠ¡ï¼Œæˆ–è€…å…±äº«fastfileï¼Œå¯ä»¥é€šè¿‡Actionçš„è¿œç¨‹å¼•ç”¨æœºåˆ¶ã€‚æ‰€ä»¥Pluginä¸è¿‡å¤šä»‹ç»ã€‚



### æŒç»­åŒ–æ‰“åŒ…è¿˜éœ€è¦çš„Action

1.monkey

2.pod_install

3.ftp æäº¤è¿œç¨‹æœåŠ¡å™¨

4.æµ‹è¯•æ—¥å¿—è§£æ

5.jiraæäº¤bug



## å¸¸è§é—®é¢˜

#### Fastlaneå®‰è£…é—®é¢˜

å®‰è£…Fastlane(å½“å‰ç‰ˆæœ¬ï¼šruby- 2.3.1ã€fastlane 2.45.0)

```
rvmå®‰è£… 
curl -L get.rvm.io | bash -s stable  
å®‰è£…æˆåŠŸåã€å¯ç”¨rvm
source ~/.bashrc  
source ~/.bash_profile  
æµ‹è¯•å®‰è£…ç»“æœ
rvm -v
å‡çº§ruby
rvm install 2.3.1
æŸ¥çœ‹å®‰è£…çš„æ‰€æœ‰ruby
rvm list
åˆ‡æ¢ruby
rvm use 2.3.1 
è®¾ç½®rvmé»˜è®¤ç‰ˆæœ¬
rvm --default 2.3.1

fastlane å®‰è£…ï¼š
sudo gem install -n /usr/local/bin fastlane
```




#### 1.rubyç‰ˆæœ¬å¿…é¡»é«˜äº2.0ï¼Œæµ‹è¯•æœ¬æœº2.0ä¹Ÿæ— æ•ˆï¼Œæ‰€ä»¥æœ€å¥½2.0+

å‡ºç°çš„é—®é¢˜ï¼š

```
SSL errors can be caused by various components on your local machine.
Apple has recently changed their servers to require TLS 1.2, which may not be available to your system installed Ruby (2.0.0)
```

æˆ–è€…ä¹‹å‰å®‰è£…è¿‡fastlaneä¼šå‡ºç°ã€ç”±äºfastlane å’Œ rubyç‰ˆæœ¬ä¸å¤Ÿ

```
Connection reset by peer - SSL_connect é—®é¢˜å¹¶ä¸”å¸¦æœ‰è§£é‡Šï¼Œè®©ä½ æ›´æ–°rubyé‡è£…fastlane
```

æ›´æ–°å®Œruby è®°å¾—è¿›è¡Œ fastlaneé‡è£…(uninstall - install)  , æ³¨æ„ç‰ˆæœ¬çš„åˆ‡æ¢, cocoapodsä¹Ÿéœ€è¦é‡æ–°å®‰è£…



Connection reset by peer - SSL_connect  é—®é¢˜å…¨éƒ¨exception

```
[17:14:30]: fastlane finished with errors
[17:14:30]: -----------------------------------------------------------------------
[17:14:30]: Connection reset by peer - SSL_connect
[17:14:30]: 
[17:14:30]: SSL errors can be caused by various components on your local machine.
[17:14:30]: Apple has recently changed their servers to require TLS 1.2, which may
[17:14:30]: not be available to your system installed Ruby (2.0.0)
[17:14:30]: 
[17:14:30]: The best solution is to use the self-contained fastlane version.
[17:14:30]: Which ships with a bundled OpenSSL,ruby and all gems - so you don't depend on system libraries
[17:14:30]:  - Use One-Click-Installer:
[17:14:30]:     - download fastlane at https://download.fastlane.tools
[17:14:30]: -----------------------------------------------------------
[17:14:30]:     - extract the archive and double click the `install`
[17:14:30]: -----------------------------------------------------------
[17:14:30]:  - Use Homebrew
[17:14:30]:     - update brew with `brew update`
[17:14:30]:     - install fastlane:
[17:14:30]: -----------------------------------------------------------
[17:14:30]:       - ğŸš€ `brew cask install fastlane` ğŸš€
[17:14:30]: -----------------------------------------------------------
[17:14:30]: for more details on ways to install fastlane please refer the documentation:
[17:14:30]: -----------------------------------------------------------
[17:14:30]:         ğŸš€       https://docs.fastlane.tools          ğŸš€   
[17:14:30]: -----------------------------------------------------------
[17:14:30]: 
[17:14:30]: You can also install a new version of Ruby
[17:14:30]: 
[17:14:30]: - Make sure OpenSSL is installed with Homebrew: `brew update && brew upgrade openssl`
[17:14:30]: - If you use system Ruby:
[17:14:30]:   - Run `brew update && brew install ruby`
[17:14:30]: - If you use rbenv with ruby-build:
[17:14:30]:   - Run `brew update && brew upgrade ruby-build && rbenv install 2.3.1`
[17:14:30]:   - Run `rbenv global 2.3.1` to make it the new global default Ruby version
[17:14:30]: - If you use rvm:
[17:14:30]:   - First run `rvm osx-ssl-certs update all`
[17:14:30]:   - Then run `rvm reinstall ruby-2.3.1 --with-openssl-dir=/usr/local`
[17:14:30]: 
[17:14:30]: If that doesn't fix your issue, please google for the following error message:
[17:14:30]:   'Connection reset by peer - SSL_connect'
[17:14:30]: -----------------------------------------------------------------------

[!] Connection reset by peer - SSL_connect
```

[ Error running 'requirements_osx_brew_update_system ruby-2.3.1](http://blog.csdn.net/qqlinxi/article/details/53648227)

å¦‚æœä½¿ç”¨RVMå®‰è£…rubyï¼Œéœ€è¦homebrew



#### 2.Jenkins ç¯å¢ƒ RVMæœªæ¿€æ´»é—®é¢˜

jenkinsä¸­è·å–ä¸åˆ°åœ¨ç›®æ ‡æœåŠ¡å™¨å®‰è£…çš„æœ€æ–°RVM å’Œ rubyã€fastlane

è§£å†³æ–¹æ¡ˆ :

~/.bashrc ã€~/.zshrc  ã€~/.zlogin å†…å®¹

```
PATH=$PATH:$HOME/.rvm/bin
[[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm" # Load RVM 
```

åœ¨jenkinsæ‰§è¡Œè„šæœ¬å†… å¯ç”¨RVMï¼š

```
source $HOME/.rvm/scripts/rvm
```



#### 3.å…³äºiOS11æ–°ä¸¤æ­¥éªŒè¯å¯¹ Jenkins è‡ªåŠ¨åŒ–å‡ºåŒ…å’ŒæåŒ…çš„å½±å“





